import streamlit as st
import time
import random
import re
from datetime import datetime
from dataclasses import dataclass
from typing import List, Optional, Dict

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(
    page_title="AIæ­è¼‰ ç·åˆé¸æŠœå‹å…¥è©¦ å°è«–æ–‡å¯¾ç­–ã‚¢ãƒ—ãƒª",
    page_icon="ğŸ“",
    layout="wide"
)

# ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹å®šç¾©
@dataclass
class PastQuestion:
    id: str
    year: int
    theme: str
    time_limit: int
    university: str
    faculty: str
    department: str

@dataclass
class Department:
    id: str
    name: str
    has_ao: bool
    past_questions: List[PastQuestion]

@dataclass
class Faculty:
    id: str
    name: str
    departments: List[Department]
    has_ao: bool

@dataclass
class University:
    id: str
    name: str
    faculties: List[Faculty]

# æ‹¡å¼µã•ã‚ŒãŸå¤§å­¦ãƒ‡ãƒ¼ã‚¿
@st.cache_data
def get_universities():
    return [
        University(
            id='waseda',
            name='æ—©ç¨²ç”°å¤§å­¦',
            faculties=[
                Faculty(
                    id='political-science',
                    name='æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='politics',
                            name='æ”¿æ²»å­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('waseda-pol-2023', 2023, 'ãƒ‡ã‚¸ã‚¿ãƒ«ç¤¾ä¼šã«ãŠã‘ã‚‹æ°‘ä¸»ä¸»ç¾©ã®èª²é¡Œã¨å¯èƒ½æ€§ã«ã¤ã„ã¦ã€å…·ä½“ä¾‹ã‚’æŒ™ã’ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'æ”¿æ²»å­¦ç§‘'),
                                PastQuestion('waseda-pol-2022', 2022, 'ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ãŒé€²ã‚€ç¾ä»£ã«ãŠã„ã¦ã€å›½å®¶ã®å½¹å‰²ã¯ã©ã®ã‚ˆã†ã«å¤‰åŒ–ã™ã¹ãã‹è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'æ”¿æ²»å­¦ç§‘'),
                                PastQuestion('waseda-pol-2021', 2021, 'ã‚³ãƒ­ãƒŠç¦ã‚’é€šã˜ã¦è¦‹ãˆãŸç¾ä»£ç¤¾ä¼šã®èª²é¡Œã¨ã€ãã®è§£æ±ºç­–ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'æ”¿æ²»å­¦ç§‘'),
                                PastQuestion('waseda-pol-2020', 2020, 'æŒç¶šå¯èƒ½ãªç¤¾ä¼šã®å®Ÿç¾ã«å‘ã‘ã¦ã€æ”¿æ²»ãŒæœãŸã™ã¹ãå½¹å‰²ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'æ”¿æ²»å­¦ç§‘'),
                                PastQuestion('waseda-pol-2019', 2019, 'äººå·¥çŸ¥èƒ½ã®ç™ºé”ãŒç¤¾ä¼šã«ä¸ãˆã‚‹å½±éŸ¿ã¨ã€ãã‚Œã«å¯¾ã™ã‚‹æ”¿ç­–ã®åœ¨ã‚Šæ–¹ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'æ”¿æ²»å­¦ç§‘')
                            ]
                        ),
                        Department(
                            id='economics',
                            name='çµŒæ¸ˆå­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('waseda-econ-2023', 2023, 'æ—¥æœ¬çµŒæ¸ˆã®æŒç¶šçš„æˆé•·ã«å‘ã‘ãŸèª²é¡Œã¨è§£æ±ºç­–ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('waseda-econ-2022', 2022, 'ãƒ‡ã‚¸ã‚¿ãƒ«çµŒæ¸ˆã®ç™ºå±•ãŒåŠ´åƒå¸‚å ´ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('waseda-econ-2021', 2021, 'ãƒã‚¹ãƒˆã‚³ãƒ­ãƒŠæ™‚ä»£ã®çµŒæ¸ˆæ”¿ç­–ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('waseda-econ-2020', 2020, 'ç’°å¢ƒå•é¡Œã¨çµŒæ¸ˆç™ºå±•ã®ä¸¡ç«‹ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('waseda-econ-2019', 2019, 'AIæ™‚ä»£ã«ãŠã‘ã‚‹é›‡ç”¨å‰µå‡ºã®åœ¨ã‚Šæ–¹ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘')
                            ]
                        )
                    ]
                ),
                Faculty(
                    id='law',
                    name='æ³•å­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='law',
                            name='æ³•å­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('waseda-law-2023', 2023, 'æ³•ã®æ”¯é…ã¨æ°‘ä¸»ä¸»ç¾©ã®é–¢ä¿‚ã«ã¤ã„ã¦ã€ç¾ä»£ç¤¾ä¼šã®å…·ä½“ä¾‹ã‚’æŒ™ã’ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ³•å­¦éƒ¨', 'æ³•å­¦ç§‘'),
                                PastQuestion('waseda-law-2022', 2022, 'ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚ä»£ã«ãŠã‘ã‚‹å€‹äººæƒ…å ±ä¿è­·ã¨è¡¨ç¾ã®è‡ªç”±ã®èª¿å’Œã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ³•å­¦éƒ¨', 'æ³•å­¦ç§‘'),
                                PastQuestion('waseda-law-2021', 2021, 'ã‚³ãƒ­ãƒŠç¦ã«ãŠã‘ã‚‹ç·Šæ€¥äº‹æ…‹å®£è¨€ã¨æ†²æ³•ä¸Šã®äººæ¨©åˆ¶ç´„ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ³•å­¦éƒ¨', 'æ³•å­¦ç§‘'),
                                PastQuestion('waseda-law-2020', 2020, 'å›½éš›ç¤¾ä¼šã«ãŠã‘ã‚‹æ³•ã®å½¹å‰²ã¨é™ç•Œã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ³•å­¦éƒ¨', 'æ³•å­¦ç§‘'),
                                PastQuestion('waseda-law-2019', 2019, 'AIåˆ¤æ–­ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥ã¨å¸æ³•åˆ¶åº¦ã®æœªæ¥ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ—©ç¨²ç”°å¤§å­¦', 'æ³•å­¦éƒ¨', 'æ³•å­¦ç§‘')
                            ]
                        )
                    ]
                )
            ]
        ),
        University(
            id='keio',
            name='æ…¶æ‡‰ç¾©å¡¾å¤§å­¦',
            faculties=[
                Faculty(
                    id='economics',
                    name='çµŒæ¸ˆå­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='economics',
                            name='çµŒæ¸ˆå­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('keio-econ-2023', 2023, 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ãŒé€²ã‚€ç¾ä»£ã«ãŠã„ã¦ã€çµŒæ¸ˆæ´»å‹•ã¯ã©ã®ã‚ˆã†ã«å¤‰åŒ–ã™ã¹ãã‹è«–ã˜ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('keio-econ-2022', 2022, 'ã‚°ãƒ­ãƒ¼ãƒãƒ«è³‡æœ¬ä¸»ç¾©ã®èª²é¡Œã¨æ–°ã—ã„çµŒæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®å¯èƒ½æ€§ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('keio-econ-2021', 2021, 'ã‚³ãƒ­ãƒŠç¦ãŒæ˜ã‚‰ã‹ã«ã—ãŸçµŒæ¸ˆæ ¼å·®ã®å•é¡Œã¨è§£æ±ºç­–ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('keio-econ-2020', 2020, 'æŒç¶šå¯èƒ½ãªçµŒæ¸ˆç™ºå±•ã¨ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢ä¿‚ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘'),
                                PastQuestion('keio-econ-2019', 2019, 'ãƒ‡ã‚¸ã‚¿ãƒ«é€šè²¨ã®æ™®åŠãŒé‡‘èã‚·ã‚¹ãƒ†ãƒ ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'çµŒæ¸ˆå­¦éƒ¨', 'çµŒæ¸ˆå­¦ç§‘')
                            ]
                        )
                    ]
                ),
                Faculty(
                    id='business',
                    name='å•†å­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='business',
                            name='å•†å­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('keio-bus-2023', 2023, 'ESGçµŒå–¶ãŒä¼æ¥­ä¾¡å€¤ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'å•†å­¦éƒ¨', 'å•†å­¦ç§‘'),
                                PastQuestion('keio-bus-2022', 2022, 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®é€²åŒ–ã¨æ¶ˆè²»è€…è¡Œå‹•ã®å¤‰åŒ–ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'å•†å­¦éƒ¨', 'å•†å­¦ç§‘'),
                                PastQuestion('keio-bus-2021', 2021, 'ãƒã‚¹ãƒˆã‚³ãƒ­ãƒŠæ™‚ä»£ã®ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«å¤‰é©ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'å•†å­¦éƒ¨', 'å•†å­¦ç§‘'),
                                PastQuestion('keio-bus-2020', 2020, 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ä¼æ¥­ã®ç¤¾ä¼šçš„ä¾¡å€¤å‰µé€ ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'å•†å­¦éƒ¨', 'å•†å­¦ç§‘'),
                                PastQuestion('keio-bus-2019', 2019, 'AIã‚’æ´»ç”¨ã—ãŸãƒ“ã‚¸ãƒã‚¹é©æ–°ã®å¯èƒ½æ€§ã¨èª²é¡Œã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦', 'å•†å­¦éƒ¨', 'å•†å­¦ç§‘')
                            ]
                        )
                    ]
                )
            ]
        ),
        University(
            id='todai',
            name='æ±äº¬å¤§å­¦',
            faculties=[
                Faculty(
                    id='liberal-arts',
                    name='æ•™é¤Šå­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='liberal-arts',
                            name='æ•™é¤Šå­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('todai-liberal-2023', 2023, 'å¤šæ§˜æ€§ã¨åŒ…æ‘‚æ€§ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ç¾ä»£ç¤¾ä¼šã«ãŠã„ã¦ã€æ•™è‚²ã®æœãŸã™ã¹ãå½¹å‰²ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 120, 'æ±äº¬å¤§å­¦', 'æ•™é¤Šå­¦éƒ¨', 'æ•™é¤Šå­¦ç§‘'),
                                PastQuestion('todai-liberal-2022', 2022, 'ç§‘å­¦æŠ€è¡“ã®ç™ºå±•ã¨äººé–“æ€§ã®èª¿å’Œã«ã¤ã„ã¦ã€å…·ä½“ä¾‹ã‚’æŒ™ã’ã¦è¿°ã¹ãªã•ã„ã€‚', 120, 'æ±äº¬å¤§å­¦', 'æ•™é¤Šå­¦éƒ¨', 'æ•™é¤Šå­¦ç§‘'),
                                PastQuestion('todai-liberal-2021', 2021, 'ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–æ™‚ä»£ã«ãŠã‘ã‚‹æ–‡åŒ–çš„ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ„ç¾©ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 120, 'æ±äº¬å¤§å­¦', 'æ•™é¤Šå­¦éƒ¨', 'æ•™é¤Šå­¦ç§‘'),
                                PastQuestion('todai-liberal-2020', 2020, 'æŒç¶šå¯èƒ½ãªç¤¾ä¼šã®å®Ÿç¾ã«å‘ã‘ãŸæ•™é¤Šæ•™è‚²ã®å½¹å‰²ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 120, 'æ±äº¬å¤§å­¦', 'æ•™é¤Šå­¦éƒ¨', 'æ•™é¤Šå­¦ç§‘'),
                                PastQuestion('todai-liberal-2019', 2019, 'AIæ™‚ä»£ã«ãŠã‘ã‚‹äººé–“ã®çŸ¥æ€§ã¨å‰µé€ æ€§ã®ä¾¡å€¤ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 120, 'æ±äº¬å¤§å­¦', 'æ•™é¤Šå­¦éƒ¨', 'æ•™é¤Šå­¦ç§‘')
                            ]
                        )
                    ]
                )
            ]
        ),
        University(
            id='sophia',
            name='ä¸Šæ™ºå¤§å­¦',
            faculties=[
                Faculty(
                    id='foreign-studies',
                    name='å¤–å›½èªå­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='english',
                            name='è‹±èªå­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('sophia-eng-2023', 2023, 'è¨€èªå¤šæ§˜æ€§ã®ä¿è­·ã¨å›½éš›ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¿ƒé€²ã®ä¸¡ç«‹ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'ä¸Šæ™ºå¤§å­¦', 'å¤–å›½èªå­¦éƒ¨', 'è‹±èªå­¦ç§‘'),
                                PastQuestion('sophia-eng-2022', 2022, 'ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚ä»£ã«ãŠã‘ã‚‹è¨€èªå­¦ç¿’ã®å¤‰åŒ–ã¨èª²é¡Œã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'ä¸Šæ™ºå¤§å­¦', 'å¤–å›½èªå­¦éƒ¨', 'è‹±èªå­¦ç§‘'),
                                PastQuestion('sophia-eng-2021', 2021, 'å›½éš›ç¤¾ä¼šã«ãŠã‘ã‚‹è‹±èªã®å½¹å‰²ã¨ä»–è¨€èªã¨ã®å…±å­˜ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'ä¸Šæ™ºå¤§å­¦', 'å¤–å›½èªå­¦éƒ¨', 'è‹±èªå­¦ç§‘'),
                                PastQuestion('sophia-eng-2020', 2020, 'ç•°æ–‡åŒ–ç†è§£æ•™è‚²ã®é‡è¦æ€§ã¨å®Ÿè·µæ–¹æ³•ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'ä¸Šæ™ºå¤§å­¦', 'å¤–å›½èªå­¦éƒ¨', 'è‹±èªå­¦ç§‘'),
                                PastQuestion('sophia-eng-2019', 2019, 'AIç¿»è¨³æŠ€è¡“ã®ç™ºå±•ãŒè¨€èªæ•™è‚²ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'ä¸Šæ™ºå¤§å­¦', 'å¤–å›½èªå­¦éƒ¨', 'è‹±èªå­¦ç§‘')
                            ]
                        )
                    ]
                )
            ]
        ),
        University(
            id='meiji',
            name='æ˜æ²»å¤§å­¦',
            faculties=[
                Faculty(
                    id='information',
                    name='æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨',
                    has_ao=True,
                    departments=[
                        Department(
                            id='information',
                            name='æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç§‘',
                            has_ao=True,
                            past_questions=[
                                PastQuestion('meiji-info-2023', 2023, 'SNSãŒç¾ä»£ç¤¾ä¼šã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ˜æ²»å¤§å­¦', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç§‘'),
                                PastQuestion('meiji-info-2022', 2022, 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒã‚¤ãƒ‰ã®è§£æ¶ˆã«å‘ã‘ãŸå–ã‚Šçµ„ã¿ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ˜æ²»å¤§å­¦', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç§‘'),
                                PastQuestion('meiji-info-2021', 2021, 'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒªãƒ†ãƒ©ã‚·ãƒ¼æ•™è‚²ã®é‡è¦æ€§ã¨å®Ÿè·µã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ˜æ²»å¤§å­¦', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç§‘'),
                                PastQuestion('meiji-info-2020', 2020, 'æƒ…å ±ç¤¾ä¼šã«ãŠã‘ã‚‹å€‹äººã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã«ã¤ã„ã¦è¿°ã¹ãªã•ã„ã€‚', 90, 'æ˜æ²»å¤§å­¦', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç§‘'),
                                PastQuestion('meiji-info-2019', 2019, 'AIæ™‚ä»£ã«ãŠã‘ã‚‹ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾¡å€¤ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚', 90, 'æ˜æ²»å¤§å­¦', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨', 'æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç§‘')
                            ]
                        )
                    ]
                )
            ]
        )
    ]

# AIæ©Ÿèƒ½ï¼šè©³ç´°æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ 
def detailed_essay_scoring(content: str, theme: str) -> dict:
    """AIæ­è¼‰ã®è©³ç´°æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ """
    if not content.strip():
        return {
            "total": 0,
            "structure": {"score": 0, "evaluation": "æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"},
            "content": {"score": 0, "evaluation": "å†…å®¹ãŒç¢ºèªã§ãã¾ã›ã‚“ã€‚"},
            "logic": {"score": 0, "evaluation": "è«–ç†æ€§ã‚’è©•ä¾¡ã§ãã¾ã›ã‚“ã€‚"},
            "expression": {"score": 0, "evaluation": "è¡¨ç¾ã‚’è©•ä¾¡ã§ãã¾ã›ã‚“ã€‚"},
            "detailed_feedback": "æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
            "specific_advice": ["æ–‡ç« ã‚’å…¥åŠ›ã—ã¦å†åº¦æå‡ºã—ã¦ãã ã•ã„ã€‚"],
            "model_answer": ""
        }
    
    word_count = len(content.replace(' ', '').replace('\n', ''))
    paragraphs = [p.strip() for p in content.split('\n') if p.strip()]
    sentences = [s.strip() for s in re.split(r'[ã€‚ï¼ï¼Ÿ]', content) if s.strip()]
    
    # æ§‹æˆè©•ä¾¡
    structure_score, structure_eval = evaluate_structure(content, paragraphs)
    
    # å†…å®¹è©•ä¾¡
    content_score, content_eval = evaluate_content(content, theme, word_count)
    
    # è«–ç†æ€§è©•ä¾¡
    logic_score, logic_eval = evaluate_logic(content, sentences)
    
    # è¡¨ç¾è©•ä¾¡
    expression_score, expression_eval = evaluate_expression(content, sentences, word_count)
    
    total_score = structure_score + content_score + logic_score + expression_score
    
    # è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
    detailed_feedback = generate_detailed_feedback(total_score, structure_score, content_score, logic_score, expression_score)
    
    # å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
    specific_advice = generate_specific_advice(content, structure_score, content_score, logic_score, expression_score)
    
    # æ¨¡ç¯„è§£ç­”ç”Ÿæˆ
    model_answer = generate_model_answer(theme)
    
    return {
        "total": total_score,
        "structure": {"score": structure_score, "evaluation": structure_eval},
        "content": {"score": content_score, "evaluation": content_eval},
        "logic": {"score": logic_score, "evaluation": logic_eval},
        "expression": {"score": expression_score, "evaluation": expression_eval},
        "detailed_feedback": detailed_feedback,
        "specific_advice": specific_advice,
        "model_answer": model_answer
    }

def evaluate_structure(content: str, paragraphs: List[str]) -> tuple:
    """æ§‹æˆè©•ä¾¡"""
    score = 0
    evaluation_parts = []
    
    # æ®µè½æ•°è©•ä¾¡
    if len(paragraphs) >= 4:
        score += 8
        evaluation_parts.append("é©åˆ‡ãªæ®µè½æ•°ï¼ˆåºè«–ãƒ»æœ¬è«–ãƒ»çµè«–ï¼‰ãŒç¢ºä¿ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    elif len(paragraphs) >= 3:
        score += 6
        evaluation_parts.append("åŸºæœ¬çš„ãªä¸‰æ®µæ§‹æˆãŒç¢ºèªã§ãã¾ã™ã€‚")
    else:
        score += 2
        evaluation_parts.append("æ®µè½æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚åºè«–ãƒ»æœ¬è«–ãƒ»çµè«–ã®æ§‹æˆã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚")
    
    # åºè«–ã®è©•ä¾¡
    first_paragraph = paragraphs[0] if paragraphs else ""
    if any(keyword in first_paragraph for keyword in ['ã«ã¤ã„ã¦', 'ã«ãŠã„ã¦', 'ã«é–¢ã—ã¦', 'ã¨ã¯']):
        score += 5
        evaluation_parts.append("åºè«–ã§é©åˆ‡ãªå•é¡Œæèµ·ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("åºè«–ã§ã®å•é¡Œæèµ·ã‚’ã‚ˆã‚Šæ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚")
    
    # çµè«–ã®è©•ä¾¡
    last_paragraph = paragraphs[-1] if paragraphs else ""
    if any(keyword in last_paragraph for keyword in ['ã‚ˆã£ã¦', 'å¾“ã£ã¦', 'ä»¥ä¸Š', 'ã“ã®ã‚ˆã†ã«', 'çµè«–ã¨ã—ã¦']):
        score += 7
        evaluation_parts.append("çµè«–éƒ¨åˆ†ã§é©åˆ‡ãªã¾ã¨ã‚ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("çµè«–ã§ã®ä¸»å¼µã®ã¾ã¨ã‚ã‚’ã‚ˆã‚Šæ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚")
    
    # æ–‡ç« ã®æµã‚Œè©•ä¾¡
    if len(paragraphs) >= 3:
        middle_paragraphs = paragraphs[1:-1]
        if any(any(keyword in p for keyword in ['ã¾ãš', 'æ¬¡ã«', 'ã•ã‚‰ã«', 'æœ€å¾Œã«']) for p in middle_paragraphs):
            score += 5
            evaluation_parts.append("è«–ç†çš„ãªé †åºç«‹ã¦ãŒç¢ºèªã§ãã¾ã™ã€‚")
    
    score = min(score, 25)
    evaluation = " ".join(evaluation_parts)
    
    return score, evaluation

def evaluate_content(content: str, theme: str, word_count: int) -> tuple:
    """å†…å®¹è©•ä¾¡"""
    score = 0
    evaluation_parts = []
    
    # æ–‡å­—æ•°è©•ä¾¡
    if word_count >= 600:
        score += 8
        evaluation_parts.append("ååˆ†ãªæ–‡å­—æ•°ã§è©³ç´°ãªè«–è¿°ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    elif word_count >= 400:
        score += 6
        evaluation_parts.append("é©åˆ‡ãªæ–‡å­—æ•°ã§è«–è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    elif word_count >= 200:
        score += 4
        evaluation_parts.append("æ–‡å­—æ•°ã¯æœ€ä½é™ã§ã™ãŒã€ã‚‚ã†å°‘ã—è©³ç´°ãªè«–è¿°ãŒæœ›ã¾ã—ã„ã§ã™ã€‚")
    else:
        evaluation_parts.append("æ–‡å­—æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šè©³ç´°ãªè«–è¿°ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
    
    # å…·ä½“ä¾‹ã®è©•ä¾¡
    example_keywords = ['ä¾‹ãˆã°', 'å…·ä½“çš„ã«', 'ãŸã¨ãˆã°', 'å®Ÿéš›ã«', 'ç¾å®Ÿã«']
    if any(keyword in content for keyword in example_keywords):
        score += 8
        evaluation_parts.append("å…·ä½“ä¾‹ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã€è«–è¨¼ãŒå¼·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("å…·ä½“ä¾‹ã‚’è¿½åŠ ã—ã¦è«–è¨¼ã‚’å¼·åŒ–ã—ã¦ãã ã•ã„ã€‚")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ»æ•°å€¤ã®æ´»ç”¨
    if re.search(r'\d+%|\d+äºº|\d+ä»¶|\d+å¹´|\d+å€', content):
        score += 6
        evaluation_parts.append("æ•°å€¤ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ãŸå®¢è¦³çš„ãªè«–è¨¼ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚")
    else:
        evaluation_parts.append("å¯èƒ½ã§ã‚ã‚Œã°çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„æ•°å€¤ã‚’ç”¨ã„ã¦è«–è¨¼ã‚’è£œå¼·ã—ã¦ãã ã•ã„ã€‚")
    
    # ãƒ†ãƒ¼ãƒã¨ã®é–¢é€£æ€§
    theme_keywords = theme.split()[:3]  # ãƒ†ãƒ¼ãƒã®æœ€åˆã®3èª
    if any(keyword in content for keyword in theme_keywords):
        score += 8
        evaluation_parts.append("ãƒ†ãƒ¼ãƒã«å¯†æ¥ã«é–¢é€£ã—ãŸå†…å®¹ã§è«–è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("ãƒ†ãƒ¼ãƒã«ã‚ˆã‚Šå¯†æ¥ã«é–¢é€£ã—ãŸå†…å®¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
    
    score = min(score, 30)
    evaluation = " ".join(evaluation_parts)
    
    return score, evaluation

def evaluate_logic(content: str, sentences: List[str]) -> tuple:
    """è«–ç†æ€§è©•ä¾¡"""
    score = 0
    evaluation_parts = []
    
    # è«–ç†çš„æ¥ç¶šè©ã®ä½¿ç”¨
    logical_connectors = ['ãã®ãŸã‚', 'ãªãœãªã‚‰', 'ç†ç”±ã¯', 'ãã®çµæœ', 'ã“ã®ã“ã¨ã‹ã‚‰', 'ã¤ã¾ã‚Š', 'ã™ãªã‚ã¡']
    connector_count = sum(content.count(connector) for connector in logical_connectors)
    
    if connector_count >= 3:
        score += 8
        evaluation_parts.append("è±Šå¯Œãªè«–ç†çš„æ¥ç¶šè©ã«ã‚ˆã‚Šã€è«–ç†çš„ãªæµã‚ŒãŒæ˜ç¢ºã§ã™ã€‚")
    elif connector_count >= 2:
        score += 6
        evaluation_parts.append("è«–ç†çš„æ¥ç¶šè©ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    elif connector_count >= 1:
        score += 4
        evaluation_parts.append("è«–ç†çš„æ¥ç¶šè©ã®ä½¿ç”¨ãŒç¢ºèªã§ãã¾ã™ãŒã€ã‚‚ã†å°‘ã—å¢—ã‚„ã™ã¨ã‚ˆã‚ŠåŠ¹æœçš„ã§ã™ã€‚")
    else:
        evaluation_parts.append("è«–ç†çš„æ¥ç¶šè©ã‚’ä½¿ç”¨ã—ã¦ã€æ–‡ç« ã®æµã‚Œã‚’ã‚ˆã‚Šæ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚")
    
    # åå¯¾æ„è¦‹ã¸ã®è¨€åŠ
    counter_keywords = ['ä¸€æ–¹', 'ã—ã‹ã—', 'ãŸã ã—', 'ã‚‚ã£ã¨ã‚‚', 'ã¨ã¯ã„ãˆ', 'ã‘ã‚Œã©ã‚‚']
    if any(keyword in content for keyword in counter_keywords):
        score += 8
        evaluation_parts.append("åå¯¾æ„è¦‹ã‚„ç•°ãªã‚‹è¦–ç‚¹ã¸ã®è¨€åŠãŒã‚ã‚Šã€å¤šè§’çš„ãªè«–è¿°ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("åå¯¾æ„è¦‹ã‚„ç•°ãªã‚‹è¦–ç‚¹ã‚‚è€ƒæ…®ã—ã¦ã€ã‚ˆã‚Šå¤šè§’çš„ãªè«–è¿°ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
    
    # å› æœé–¢ä¿‚ã®æ˜ç¢ºæ€§
    causal_keywords = ['åŸå› ', 'çµæœ', 'è¦å› ', 'å½±éŸ¿', 'èƒŒæ™¯', 'æ ¹æ‹ ']
    if sum(content.count(keyword) for keyword in causal_keywords) >= 2:
        score += 6
        evaluation_parts.append("å› æœé–¢ä¿‚ãŒæ˜ç¢ºã«ç¤ºã•ã‚Œã€è«–ç†çš„ãªè«–è¨¼ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("å› æœé–¢ä¿‚ã‚’ã‚ˆã‚Šæ˜ç¢ºã«ç¤ºã—ã¦ã€è«–è¨¼ã‚’å¼·åŒ–ã—ã¦ãã ã•ã„ã€‚")
    
    # è«–ç†ã®ä¸€è²«æ€§ï¼ˆé‡è¤‡ã‚„çŸ›ç›¾ã®ãƒã‚§ãƒƒã‚¯ï¼‰
    if len(sentences) >= 5:
        score += 3
        evaluation_parts.append("é©åˆ‡ãªæ–‡æ•°ã§è«–ç†çš„ãªå±•é–‹ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    
    score = min(score, 25)
    evaluation = " ".join(evaluation_parts)
    
    return score, evaluation

def evaluate_expression(content: str, sentences: List[str], word_count: int) -> tuple:
    """è¡¨ç¾è©•ä¾¡"""
    score = 0
    evaluation_parts = []
    
    # æ–‡ä½“ã®é©åˆ‡æ€§
    if 'ã§ã‚ã‚‹' in content or 'ã ã€‚' in content:
        score += 5
        evaluation_parts.append("å°è«–æ–‡ã«é©ã—ãŸæ–‡ä½“ã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("å°è«–æ–‡ã§ã¯ã€Œã§ã‚ã‚‹èª¿ã€ã®ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚")
    
    # èªå½™ã®è±Šå¯Œã•
    unique_words = set(re.findall(r'[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾¯]+', content))
    if len(unique_words) >= 100:
        score += 6
        evaluation_parts.append("è±Šå¯Œãªèªå½™ãŒä½¿ç”¨ã•ã‚Œã€è¡¨ç¾åŠ›è±Šã‹ãªæ–‡ç« ã§ã™ã€‚")
    elif len(unique_words) >= 70:
        score += 4
        evaluation_parts.append("é©åˆ‡ãªèªå½™ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("ã‚ˆã‚Šå¤šæ§˜ãªèªå½™ã‚’ä½¿ç”¨ã—ã¦è¡¨ç¾åŠ›ã‚’å‘ä¸Šã•ã›ã¦ãã ã•ã„ã€‚")
    
    # æ–‡ã®é•·ã•ã®ãƒãƒ©ãƒ³ã‚¹
    if sentences:
        avg_sentence_length = sum(len(s) for s in sentences) / len(sentences)
        if 30 <= avg_sentence_length <= 60:
            score += 4
            evaluation_parts.append("æ–‡ã®é•·ã•ãŒé©åˆ‡ã§ã€èª­ã¿ã‚„ã™ã„æ–‡ç« ã§ã™ã€‚")
        else:
            evaluation_parts.append("æ–‡ã®é•·ã•ã‚’èª¿æ•´ã—ã¦ã€èª­ã¿ã‚„ã™ã•ã‚’å‘ä¸Šã•ã›ã¦ãã ã•ã„ã€‚")
    
    # é‡è¤‡è¡¨ç¾ã®ãƒã‚§ãƒƒã‚¯
    repetitive_patterns = re.findall(r'(.{5,})\1', content)
    if not repetitive_patterns:
        score += 5
        evaluation_parts.append("é‡è¤‡è¡¨ç¾ãŒãªãã€ç°¡æ½”ã§åŠ¹æœçš„ãªè¡¨ç¾ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚")
    else:
        evaluation_parts.append("ä¸€éƒ¨ã«é‡è¤‡è¡¨ç¾ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ã‚ˆã‚Šå¤šæ§˜ãªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
    
    score = min(score, 20)
    evaluation = " ".join(evaluation_parts)
    
    return score, evaluation

def generate_detailed_feedback(total: int, structure: int, content: int, logic: int, expression: int) -> str:
    """è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ"""
    if total >= 85:
        feedback = f"ç´ æ™´ã‚‰ã—ã„å°è«–æ–‡ã§ã™ï¼ˆ{total}/100ç‚¹ï¼‰ï¼å…¨ä½“çš„ã«é«˜ã„ãƒ¬ãƒ™ãƒ«ã§è«–è¿°ã•ã‚Œã¦ãŠã‚Šã€å…¥è©¦æœ¬ç•ªã§ã‚‚ååˆ†ã«é€šç”¨ã™ã‚‹å†…å®¹ã§ã™ã€‚"
    elif total >= 70:
        feedback = f"è‰¯å¥½ãªå°è«–æ–‡ã§ã™ï¼ˆ{total}/100ç‚¹ï¼‰ã€‚åŸºæœ¬çš„ãªè¦ç´ ã¯ååˆ†ã«æº€ãŸã•ã‚Œã¦ãŠã‚Šã€ã„ãã¤ã‹ã®æ”¹å–„ç‚¹ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã•ã‚‰ã«é«˜ã„è©•ä¾¡ãŒæœŸå¾…ã§ãã¾ã™ã€‚"
    elif total >= 55:
        feedback = f"æ¨™æº–çš„ãªå°è«–æ–‡ã§ã™ï¼ˆ{total}/100ç‚¹ï¼‰ã€‚åŸºæœ¬çš„ãªæ§‹æˆã¯ã§ãã¦ã„ã¾ã™ãŒã€å†…å®¹ã®æ·±åŒ–ã¨è«–ç†æ€§ã®å¼·åŒ–ãŒå¿…è¦ã§ã™ã€‚"
    elif total >= 40:
        feedback = f"æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ï¼ˆ{total}/100ç‚¹ï¼‰ã€‚æ§‹æˆã‚„è«–ç†å±•é–‹ã‚’è¦‹ç›´ã—ã€ã‚ˆã‚Šå…·ä½“çš„ã§èª¬å¾—åŠ›ã®ã‚ã‚‹è«–è¿°ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚"
    else:
        feedback = f"å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦ã§ã™ï¼ˆ{total}/100ç‚¹ï¼‰ã€‚å°è«–æ–‡ã®åŸºæœ¬çš„ãªæ›¸ãæ–¹ã‹ã‚‰è¦‹ç›´ã—ã€æ§‹æˆãƒ»å†…å®¹ãƒ»è«–ç†æ€§ã®ã™ã¹ã¦ã®é¢ã§å‘ä¸Šã‚’å›³ã£ã¦ãã ã•ã„ã€‚"
    
    # å„é …ç›®ã§ã®å¼·ã¿ãƒ»å¼±ã¿ã‚’è¿½åŠ 
    strengths = []
    weaknesses = []
    
    if structure >= 20: strengths.append("æ§‹æˆ")
    elif structure < 15: weaknesses.append("æ§‹æˆ")
    
    if content >= 24: strengths.append("å†…å®¹")
    elif content < 18: weaknesses.append("å†…å®¹")
    
    if logic >= 20: strengths.append("è«–ç†æ€§")
    elif logic < 15: weaknesses.append("è«–ç†æ€§")
    
    if expression >= 16: strengths.append("è¡¨ç¾")
    elif expression < 12: weaknesses.append("è¡¨ç¾")
    
    if strengths:
        feedback += f" ç‰¹ã«{'/'.join(strengths)}ã®é¢ã§å„ªã‚Œã¦ã„ã¾ã™ã€‚"
    if weaknesses:
        feedback += f" {'/'.join(weaknesses)}ã®é¢ã§ã®æ”¹å–„ãŒé‡è¦ã§ã™ã€‚"
    
    return feedback

def generate_specific_advice(content: str, structure: int, content_score: int, logic: int, expression: int) -> List[str]:
    """å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ"""
    advice = []
    
    # æ§‹æˆã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    if structure < 20:
        paragraphs = [p.strip() for p in content.split('\n') if p.strip()]
        if len(paragraphs) < 3:
            advice.append("ã€æ§‹æˆæ”¹å–„ã€‘åºè«–ãƒ»æœ¬è«–ãƒ»çµè«–ã®ä¸‰æ®µæ§‹æˆã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚å„æ®µè½ã®å½¹å‰²ã‚’æ„è­˜ã—ã¦ã€åºè«–ã§å•é¡Œæèµ·ã€æœ¬è«–ã§è«–è¨¼ã€çµè«–ã§ã¾ã¨ã‚ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚")
        
        first_paragraph = paragraphs[0] if paragraphs else ""
        if not any(keyword in first_paragraph for keyword in ['ã«ã¤ã„ã¦', 'ã«ãŠã„ã¦', 'ã«é–¢ã—ã¦']):
            advice.append("ã€åºè«–æ”¹å–„ã€‘åºè«–ã§ã¯ã€Œã€œã«ã¤ã„ã¦ã€ã€Œã€œã«ãŠã„ã¦ã€ãªã©ã‚’ä½¿ã£ã¦ã€æ˜ç¢ºã«å•é¡Œæèµ·ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€è¿‘å¹´ã€ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã«ã¤ã„ã¦æ§˜ã€…ãªè­°è«–ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã€‚ã€")
    
    # å†…å®¹ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    if content_score < 24:
        if not any(keyword in content for keyword in ['ä¾‹ãˆã°', 'å…·ä½“çš„ã«', 'ãŸã¨ãˆã°']):
            advice.append("ã€å†…å®¹å¼·åŒ–ã€‘å…·ä½“ä¾‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ã€ä¾‹ãˆã°ã€ã€œã®å ´åˆã€ã€ã€å…·ä½“çš„ã«ã¯ã€ã€ãªã©ã‚’ä½¿ã£ã¦ã€å®Ÿéš›ã®äº‹ä¾‹ã‚„ä½“é¨“ã‚’æŒ™ã’ã‚‹ã¨èª¬å¾—åŠ›ãŒå¢—ã—ã¾ã™ã€‚")
        
        if not re.search(r'\d+%|\d+äºº|\d+ä»¶|\d+å¹´', content):
            advice.append("ã€ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã€‘å¯èƒ½ãªç¯„å›²ã§çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„æ•°å€¤ã‚’å«ã‚ã¦ãã ã•ã„ã€‚ã€ç´„70%ã®ä¼æ¥­ãŒã€ã€éå»10å¹´é–“ã§ã€ãªã©ã®è¡¨ç¾ã«ã‚ˆã‚Šã€å®¢è¦³æ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚")
    
    # è«–ç†æ€§ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    if logic < 20:
        logical_connectors = ['ãã®ãŸã‚', 'ãªãœãªã‚‰', 'ãã®çµæœ', 'ã“ã®ã“ã¨ã‹ã‚‰']
        if not any(connector in content for connector in logical_connectors):
            advice.append("ã€è«–ç†æ€§å‘ä¸Šã€‘è«–ç†çš„æ¥ç¶šè©ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã€ãã®ãŸã‚ã€ã€ãªãœãªã‚‰ã€ã€ãã®çµæœã€ãªã©ã«ã‚ˆã‚Šã€è«–ç†ã®æµã‚Œã‚’æ˜ç¢ºã«ã—ã¾ã—ã‚‡ã†ã€‚")
        
        if not any(keyword in content for keyword in ['ä¸€æ–¹', 'ã—ã‹ã—', 'ãŸã ã—']):
            advice.append("ã€å¤šè§’çš„è¦–ç‚¹ã€‘åå¯¾æ„è¦‹ã«ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚ã€ä¸€æ–¹ã§ã€ã€ã—ã‹ã—ã€ãªã©ã‚’ä½¿ã£ã¦ç•°ãªã‚‹ç«‹å ´ã®æ„è¦‹ã‚’ç´¹ä»‹ã—ã€ãã®ä¸Šã§è‡ªåˆ†ã®ä¸»å¼µã‚’å±•é–‹ã™ã‚‹ã¨èª¬å¾—åŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚")
    
    # è¡¨ç¾ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    if expression < 16:
        if 'æ€ã„ã¾ã™' in content or 'æ€ã†' in content:
            advice.append("ã€æ–‡ä½“æ”¹å–„ã€‘å°è«–æ–‡ã§ã¯ã€æ€ã†ã€ã§ã¯ãªãã€è€ƒãˆã‚‹ã€ã€è¿°ã¹ã‚‹ã€ã€è«–ã˜ã‚‹ã€ãªã©ã®è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ã€ã§ã‚ã‚‹èª¿ã€ã§çµ±ä¸€ã—ã¾ã—ã‚‡ã†ã€‚")
        
        sentences = [s.strip() for s in re.split(r'[ã€‚ï¼ï¼Ÿ]', content) if s.strip()]
        if sentences:
            avg_length = sum(len(s) for s in sentences) / len(sentences)
            if avg_length < 20:
                advice.append("ã€æ–‡ç« æ§‹æˆã€‘æ–‡ãŒã‚„ã‚„çŸ­ã™ãã¾ã™ã€‚ä¿®é£¾èªã‚„å…·ä½“ä¾‹ã‚’åŠ ãˆã¦ã€ã‚ˆã‚Šè©³ç´°ã§è±Šã‹ãªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
            elif avg_length > 80:
                advice.append("ã€æ–‡ç« æ§‹æˆã€‘æ–‡ãŒé•·ã™ãã¦èª­ã¿ã«ãããªã£ã¦ã„ã¾ã™ã€‚é©åˆ‡ãªç®‡æ‰€ã§æ–‡ã‚’åˆ†å‰²ã—ã€èª­ã¿ã‚„ã™ã•ã‚’å‘ä¸Šã•ã›ã¦ãã ã•ã„ã€‚")
    
    # å…¨ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
    word_count = len(content.replace(' ', '').replace('\n', ''))
    if word_count < 400:
        advice.append("ã€æ–‡å­—æ•°ã€‘ã‚‚ã†å°‘ã—è©³ç´°ãªè«–è¿°ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚æ ¹æ‹ ã®èª¬æ˜ã‚„å…·ä½“ä¾‹ã®è©³ç´°åŒ–ã«ã‚ˆã‚Šã€æ–‡å­—æ•°ã¨èª¬å¾—åŠ›ã®ä¸¡æ–¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚")
    
    return advice

def generate_model_answer(theme: str) -> str:
    """AIã«ã‚ˆã‚‹æ¨¡ç¯„è§£ç­”ç”Ÿæˆ"""
    # ãƒ†ãƒ¼ãƒã«åŸºã¥ã„ã¦æ¨¡ç¯„è§£ç­”ã‚’ç”Ÿæˆ
    model_answers = {
        "ãƒ‡ã‚¸ã‚¿ãƒ«": """ã€æ¨¡ç¯„è§£ç­”ä¾‹ã€‘
ç¾ä»£ç¤¾ä¼šã«ãŠã‘ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã®é€²å±•ã¯ã€æˆ‘ã€…ã®ç”Ÿæ´»æ§˜å¼ã‚’æ ¹æœ¬çš„ã«å¤‰é©ã—ã¦ã„ã‚‹ã€‚ã“ã®å¤‰åŒ–ã«ã¤ã„ã¦ã€ãã®æ„ç¾©ã¨èª²é¡Œã‚’å¤šè§’çš„ã«æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã¾ãšã€ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã®åˆ©ç‚¹ã¨ã—ã¦ã€æƒ…å ±ã‚¢ã‚¯ã‚»ã‚¹ã®å¹³ç­‰åŒ–ãŒæŒ™ã’ã‚‰ã‚Œã‚‹ã€‚ä¾‹ãˆã°ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ•™è‚²ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ˆã‚Šã€åœ°ç†çš„åˆ¶ç´„ã‚’è¶…ãˆãŸå­¦ç¿’æ©Ÿä¼šãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã€‚å®Ÿéš›ã«ã€ã‚³ãƒ­ãƒŠç¦ã«ãŠã„ã¦å¤šãã®æ•™è‚²æ©Ÿé–¢ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³æˆæ¥­ã‚’å°å…¥ã—ã€æ•™è‚²ã®ç¶™ç¶šæ€§ã‚’ä¿ã¤ã“ã¨ãŒã§ããŸã€‚

ä¸€æ–¹ã§ã€ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒã‚¤ãƒ‰ã¨ã„ã†èª²é¡Œã‚‚å­˜åœ¨ã™ã‚‹ã€‚é«˜é½¢è€…ã‚„ä½æ‰€å¾—ä¸–å¸¯ã«ãŠã„ã¦ã€ãƒ‡ã‚¸ã‚¿ãƒ«æŠ€è¡“ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã€‚ã“ã®å•é¡Œã«å¯¾ã—ã¦ã¯ã€æ”¿åºœã‚„è‡ªæ²»ä½“ã«ã‚ˆã‚‹æ”¯æ´ç­–ã®å……å®ŸãŒä¸å¯æ¬ ã§ã‚ã‚‹ã€‚

ã•ã‚‰ã«ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã¨ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚‚é‡è¦ãªè«–ç‚¹ã§ã‚ã‚‹ã€‚ä¼æ¥­ãŒãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ä¸€æ–¹ã§ã€å€‹äººæƒ…å ±ã®é©åˆ‡ãªç®¡ç†ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚

ã“ã®ã‚ˆã†ã«ã€ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã¯å¤šå¤§ãªæ©æµã‚’ã‚‚ãŸã‚‰ã™ä¸€æ–¹ã§ã€ç¤¾ä¼šçš„èª²é¡Œã‚‚ç”Ÿã¿å‡ºã—ã¦ã„ã‚‹ã€‚é‡è¦ãªã“ã¨ã¯ã€æŠ€è¡“ã®ç™ºå±•ã¨äººé–“ä¸­å¿ƒã®ä¾¡å€¤è¦³ã‚’ä¸¡ç«‹ã•ã›ã‚‹ç¤¾ä¼šã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã§ã‚ã‚‹ã€‚""",
        
        "AI": """ã€æ¨¡ç¯„è§£ç­”ä¾‹ã€‘
äººå·¥çŸ¥èƒ½ï¼ˆAIï¼‰ã®æ€¥é€Ÿãªç™ºé”ã¯ã€21ä¸–ç´€æœ€å¤§ã®æŠ€è¡“é©æ–°ã¨ã—ã¦ç¤¾ä¼šã®ã‚ã‚‰ã‚†ã‚‹åˆ†é‡ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã„ã‚‹ã€‚ã“ã®å¤‰é©ã«ã¤ã„ã¦ã€ãã®å¯èƒ½æ€§ã¨èª²é¡Œã‚’ç·åˆçš„ã«æ¤œè¨ã—ãŸã„ã€‚

AIã®æœ€å¤§ã®åˆ©ç‚¹ã¯ã€äººé–“ã®èƒ½åŠ›ã‚’æ‹¡å¼µã—ã€åŠ¹ç‡æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚åŒ»ç™‚åˆ†é‡ã§ã¯ã€AIè¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šæ—©æœŸç™ºè¦‹ç‡ãŒå‘ä¸Šã—ã€å¤šãã®ç”Ÿå‘½ãŒæ•‘ã‚ã‚Œã¦ã„ã‚‹ã€‚ã¾ãŸã€è‡ªå‹•é‹è»¢æŠ€è¡“ã®ç™ºå±•ã«ã‚ˆã‚Šã€äº¤é€šäº‹æ•…ã®å¤§å¹…ãªæ¸›å°‘ãŒæœŸå¾…ã•ã‚Œã¦ã„ã‚‹ã€‚

ã—ã‹ã—ã€é›‡ç”¨ã¸ã®å½±éŸ¿ã¨ã„ã†æ·±åˆ»ãªèª²é¡Œã‚‚å­˜åœ¨ã™ã‚‹ã€‚å˜ç´”ä½œæ¥­ã®è‡ªå‹•åŒ–ã«ã‚ˆã‚Šã€ä¸€éƒ¨ã®è·ç¨®ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ã“ã®å•é¡Œã«å¯¾ã—ã¦ã¯ã€ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°ï¼ˆå†æ•™è‚²ï¼‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å……å®Ÿã‚„ã€æ–°ãŸãªä¾¡å€¤å‰µé€ åˆ†é‡ã§ã®é›‡ç”¨å‰µå‡ºãŒé‡è¦ã§ã‚ã‚‹ã€‚

ã•ã‚‰ã«ã€AIåˆ¤æ–­ã®é€æ˜æ€§ã¨è²¬ä»»ã®æ‰€åœ¨ã‚‚é‡è¦ãªè«–ç‚¹ã§ã‚ã‚‹ã€‚é‡‘èã‚„å¸æ³•ãªã©ã®é‡è¦ãªåˆ¤æ–­ã«AIãŒé–¢ä¸ã™ã‚‹å ´åˆã€ãã®æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹ã®èª¬æ˜å¯èƒ½æ€§ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚

çµè«–ã¨ã—ã¦ã€AIã¨äººé–“ã®å…±å­˜ã«ã¯ã€æŠ€è¡“çš„é€²æ­©ã¨å€«ç†çš„é…æ…®ã®ä¸¡ç«‹ãŒä¸å¯æ¬ ã§ã‚ã‚‹ã€‚AIã‚’è„…å¨ã¨ã—ã¦æ‰ãˆã‚‹ã®ã§ã¯ãªãã€äººé–“æ€§ã‚’å°Šé‡ã—ãªãŒã‚‰æŠ€è¡“ã‚’æ´»ç”¨ã™ã‚‹ç¤¾ä¼šã®å®Ÿç¾ã‚’ç›®æŒ‡ã™ã¹ãã§ã‚ã‚‹ã€‚""",
        
        "æŒç¶šå¯èƒ½": """ã€æ¨¡ç¯„è§£ç­”ä¾‹ã€‘
æŒç¶šå¯èƒ½ãªç¤¾ä¼šã®å®Ÿç¾ã¯ã€ç¾ä»£ç¤¾ä¼šãŒç›´é¢ã™ã‚‹æœ€é‡è¦èª²é¡Œã®ä¸€ã¤ã§ã‚ã‚‹ã€‚ç’°å¢ƒä¿è­·ã¨çµŒæ¸ˆç™ºå±•ã®ä¸¡ç«‹ã«ã¤ã„ã¦ã€å¤šé¢çš„ãªæ¤œè¨ã‚’è¡Œã„ãŸã„ã€‚

æŒç¶šå¯èƒ½æ€§ã®æ ¸å¿ƒã¯ã€å°†æ¥ä¸–ä»£ã®ãƒ‹ãƒ¼ã‚ºã‚’æãªã†ã“ã¨ãªãã€ç¾åœ¨ã®ãƒ‹ãƒ¼ã‚ºã‚’æº€ãŸã™ã“ã¨ã§ã‚ã‚‹ã€‚ã“ã®è¦³ç‚¹ã‹ã‚‰ã€ã¾ãšç’°å¢ƒè² è·ã®å‰Šæ¸›ãŒä¸å¯æ¬ ã§ã‚ã‚‹ã€‚ä¾‹ãˆã°ã€å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ™®åŠã«ã‚ˆã‚Šã€CO2æ’å‡ºé‡ã®å¤§å¹…ãªå‰Šæ¸›ãŒå¯èƒ½ã¨ãªã‚‹ã€‚å®Ÿéš›ã«ã€å¤ªé™½å…‰ç™ºé›»ã‚³ã‚¹ãƒˆã®ä½ä¸‹ã«ã‚ˆã‚Šã€å¤šãã®å›½ã§å°å…¥ãŒé€²ã‚“ã§ã„ã‚‹ã€‚

ä¸€æ–¹ã§ã€æ€¥æ¿€ãªç’°å¢ƒæ”¿ç­–ã®å®Ÿæ–½ã¯çµŒæ¸ˆæ´»å‹•ã«è² ã®å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ã“ã®ãŸã‚ã€æ®µéšçš„ãªç§»è¡Œè¨ˆç”»ã¨ä¼æ¥­ã¸ã®æ”¯æ´åˆ¶åº¦ãŒé‡è¦ã§ã‚ã‚‹ã€‚ä¾‹ãˆã°ã€ç‚­ç´ ç¨ã®å°å…¥ã¨åŒæ™‚ã«ã€ã‚°ãƒªãƒ¼ãƒ³æŠ€è¡“ã¸ã®æŠ•è³‡æ”¯æ´ã‚’è¡Œã†æ”¿ç­–ãŒåŠ¹æœçš„ã§ã‚ã‚‹ã€‚

ã¾ãŸã€æ¶ˆè²»è€…ã®æ„è­˜å¤‰é©ã‚‚æ¬ ã‹ã›ãªã„è¦ç´ ã§ã‚ã‚‹ã€‚æŒç¶šå¯èƒ½ãªå•†å“ã®é¸æŠã‚„ã€å¾ªç’°å‹æ¶ˆè²»è¡Œå‹•ã®å®šç€ã«ã‚ˆã‚Šã€å¸‚å ´ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’é€šã˜ãŸå¤‰åŒ–ãŒä¿ƒé€²ã•ã‚Œã‚‹ã€‚

ã“ã®ã‚ˆã†ã«ã€æŒç¶šå¯èƒ½ãªç¤¾ä¼šã®å®Ÿç¾ã«ã¯ã€æ”¿åºœãƒ»ä¼æ¥­ãƒ»å¸‚æ°‘ã®å”åƒãŒä¸å¯æ¬ ã§ã‚ã‚‹ã€‚çŸ­æœŸçš„ãªåˆ©ç›Šã«ã¨ã‚‰ã‚ã‚Œãšã€é•·æœŸçš„è¦–ç‚¹ã«ç«‹ã£ãŸç¤¾ä¼šè¨­è¨ˆã‚’é€²ã‚ã‚‹ã“ã¨ãŒã€æˆ‘ã€…ã«æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹è²¬å‹™ã§ã‚ã‚‹ã€‚"""
    }
    
    # ãƒ†ãƒ¼ãƒã«æœ€ã‚‚é–¢é€£ã™ã‚‹æ¨¡ç¯„è§£ç­”ã‚’é¸æŠ
    for key, answer in model_answers.items():
        if key in theme:
            return answer
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¨¡ç¯„è§£ç­”
    return """ã€æ¨¡ç¯„è§£ç­”ä¾‹ã€‘
ç¾ä»£ç¤¾ä¼šã¯æ€¥é€Ÿãªå¤‰åŒ–ã®ä¸­ã«ã‚ã‚Šã€å¤šæ§˜ãªèª²é¡Œã¨å¯èƒ½æ€§ãŒä½µå­˜ã—ã¦ã„ã‚‹ã€‚æœ¬ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦ã€ãã®æ„ç¾©ã¨èª²é¡Œã‚’å¤šè§’çš„ã«æ¤œè¨ã—ãŸã„ã€‚

ã¾ãšã€ã“ã®å•é¡Œã®é‡è¦æ€§ã«ã¤ã„ã¦è¿°ã¹ã‚‹ã€‚ç¤¾ä¼šã®å¤‰åŒ–ã¯ã€æˆ‘ã€…ã®ç”Ÿæ´»æ§˜å¼ã‚„ä¾¡å€¤è¦³ã«å¤§ããªå½±éŸ¿ã‚’ä¸ãˆã¦ã„ã‚‹ã€‚ä¾‹ãˆã°ã€æŠ€è¡“ã®ç™ºå±•ã«ã‚ˆã‚Šæ–°ãŸãªæ©Ÿä¼šãŒç”Ÿã¾ã‚Œã‚‹ä¸€æ–¹ã§ã€å¾“æ¥ã®åˆ¶åº¦ã‚„æ…£ç¿’ã¨ã®é–“ã«æ‘©æ“¦ãŒç”Ÿã˜ã¦ã„ã‚‹ã€‚

ä¸€æ–¹ã§ã€ã“ã®å¤‰åŒ–ã«ã¯èª²é¡Œã‚‚ä¼´ã†ã€‚æ€¥æ¿€ãªå¤‰åŒ–ã¯ç¤¾ä¼šã®ä¸€éƒ¨ã«è² ã®å½±éŸ¿ã‚’ã‚‚ãŸã‚‰ã—ã€æ ¼å·®ã®æ‹¡å¤§ã‚„ä¸å®‰ã®å¢—å¤§ã‚’æ‹›ãå¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ã“ã®ãŸã‚ã€å¤‰åŒ–ã®ãƒ¡ãƒªãƒƒãƒˆã‚’æœ€å¤§åŒ–ã—ã¤ã¤ã€è² ã®å½±éŸ¿ã‚’æœ€å°é™ã«æŠ‘åˆ¶ã™ã‚‹æ”¿ç­–çš„é…æ…®ãŒé‡è¦ã§ã‚ã‚‹ã€‚

ã•ã‚‰ã«ã€æŒç¶šå¯èƒ½ãªç™ºå±•ã®è¦³ç‚¹ã‹ã‚‰ã€é•·æœŸçš„è¦–ç‚¹ã«ç«‹ã£ãŸå–ã‚Šçµ„ã¿ãŒå¿…è¦ã§ã‚ã‚‹ã€‚çŸ­æœŸçš„ãªåˆ©ç›Šã«ã¨ã‚‰ã‚ã‚Œã‚‹ã“ã¨ãªãã€å°†æ¥ä¸–ä»£ã¸ã®è²¬ä»»ã‚’è€ƒæ…®ã—ãŸæ„æ€æ±ºå®šãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚

çµè«–ã¨ã—ã¦ã€ç¾ä»£ç¤¾ä¼šã®èª²é¡Œè§£æ±ºã«ã¯ã€å¤šæ§˜ãªç«‹å ´ã®äººã€…ãŒå”åƒã—ã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè­°è«–ã‚’é€šã˜ã¦æœ€é©è§£ã‚’è¦‹å‡ºã™ã“ã¨ãŒé‡è¦ã§ã‚ã‚‹ã€‚å¤‰åŒ–ã‚’æã‚Œã‚‹ã®ã§ã¯ãªãã€ç©æ¥µçš„ã«å‘ãåˆã„ã€ã‚ˆã‚Šè‰¯ã„ç¤¾ä¼šã®å®Ÿç¾ã‚’ç›®æŒ‡ã™ã¹ãã§ã‚ã‚‹ã€‚"""

# AIå•é¡Œäºˆæƒ³æ©Ÿèƒ½
def ai_generate_question(past_questions: List[PastQuestion], university: str, faculty: str, department: str) -> str:
    """AIã«ã‚ˆã‚‹å•é¡Œäºˆæƒ³"""
    
    # éå»å•é¡Œã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
    themes = [q.theme for q in past_questions]
    all_themes_text = " ".join(themes)
    
    # ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å®šç¾©
    current_trends = [
        'ãƒ‡ã‚¸ã‚¿ãƒ«å¤‰é©', 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’', 'æŒç¶šå¯èƒ½æ€§', 'ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«',
        'ãƒ€ã‚¤ãƒãƒ¼ã‚·ãƒ†ã‚£', 'ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³', 'åƒãæ–¹æ”¹é©', 'ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°',
        'ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–', 'ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³', 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—',
        'ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼ã‚¨ã‚³ãƒãƒŸãƒ¼', 'SDGs', 'ESGçµŒå–¶', 'ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°',
        'ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹', 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒã‚¤ãƒ‰', 'ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿'
    ]
    
    # å­¦éƒ¨ãƒ»å­¦ç§‘åˆ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    domain_contexts = {
        'æ”¿æ²»': ['æ°‘ä¸»ä¸»ç¾©', 'æ”¿ç­–ç«‹æ¡ˆ', 'å›½éš›é–¢ä¿‚', 'å…¬å…±æ”¿ç­–', 'è¡Œæ”¿æ”¹é©', 'åœ°æ–¹å‰µç”Ÿ'],
        'çµŒæ¸ˆ': ['å¸‚å ´çµŒæ¸ˆ', 'é‡‘èæ”¿ç­–', 'ç”£æ¥­æ§‹é€ ', 'åŠ´åƒå¸‚å ´', 'å›½éš›è²¿æ˜“', 'çµŒæ¸ˆæ ¼å·®'],
        'æ³•': ['æ³•åˆ¶åº¦', 'äººæ¨©ä¿è­·', 'å¸æ³•åˆ¶åº¦', 'å›½éš›æ³•', 'ä¼æ¥­æ³•å‹™', 'æ†²æ³•æ”¹æ­£'],
        'å•†': ['ä¼æ¥­çµŒå–¶', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«', 'èµ·æ¥­', 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', 'ESG'],
        'å¤–å›½èª': ['å›½éš›ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'å¤šè¨€èªç¤¾ä¼š', 'ç•°æ–‡åŒ–ç†è§£', 'è¨€èªæ•™è‚²', 'ç¿»è¨³æŠ€è¡“'],
        'æƒ…å ±': ['æƒ…å ±ç¤¾ä¼š', 'ãƒ‡ã‚¸ã‚¿ãƒ«æŠ€è¡“', 'ãƒ¡ãƒ‡ã‚£ã‚¢', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼'],
        'æ•™é¤Š': ['äººæ–‡å­¦', 'å­¦éš›ç ”ç©¶', 'æ‰¹åˆ¤çš„æ€è€ƒ', 'æ–‡åŒ–ç ”ç©¶', 'ç¤¾ä¼šç§‘å­¦', 'ç·åˆçŸ¥']
    }
    
    # å­¦éƒ¨ãƒ»å­¦ç§‘ã«é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç‰¹å®š
    relevant_contexts = []
    for key, contexts in domain_contexts.items():
        if key in faculty or key in department:
            relevant_contexts.extend(contexts)
    
    if not relevant_contexts:
        relevant_contexts = ['ç¤¾ä¼š', 'ç¾ä»£', 'èª²é¡Œ', 'è§£æ±ºç­–', 'å°†æ¥å±•æœ›']
    
    # ãƒˆãƒ¬ãƒ³ãƒ‰ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦å•é¡Œã‚’ç”Ÿæˆ
    selected_trend = random.choice(current_trends)
    selected_context = random.choice(relevant_contexts)
    
    # éå»å•é¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ†æ
    question_styles = [
        f"{selected_trend}ãŒ{selected_context}åˆ†é‡ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦ã€å…·ä½“ä¾‹ã‚’æŒ™ã’ãªãŒã‚‰è«–ã˜ãªã•ã„ã€‚ã¾ãŸã€ä»Šå¾Œã®èª²é¡Œã¨è§£æ±ºç­–ã«ã¤ã„ã¦ã‚‚ã‚ãªãŸã®è€ƒãˆã‚’è¿°ã¹ãªã•ã„ã€‚",
        f"ç¾ä»£ç¤¾ä¼šã«ãŠã‘ã‚‹{selected_trend}ã®æ„ç¾©ã‚’è¸ã¾ãˆã€{selected_context}ã®è¦³ç‚¹ã‹ã‚‰å°†æ¥ã®ã‚ã‚‹ã¹ãå§¿ã«ã¤ã„ã¦è«–ã˜ãªã•ã„ã€‚",
        f"{selected_trend}ã®é€²å±•ã«ã‚ˆã‚Š{selected_context}åˆ†é‡ã§ç”Ÿã˜ã¦ã„ã‚‹å¤‰åŒ–ã«ã¤ã„ã¦åˆ†æã—ã€ãã‚Œã«å¯¾ã™ã‚‹é©åˆ‡ãªå¯¾å¿œç­–ã‚’æè¨€ã—ãªã•ã„ã€‚",
        f"{selected_trend}ã¨{selected_context}ã®é–¢ä¿‚æ€§ã«ã¤ã„ã¦è€ƒå¯Ÿã—ã€æŒç¶šå¯èƒ½ãªç¤¾ä¼šã®å®Ÿç¾ã«å‘ã‘ãŸæ–¹ç­–ã‚’è«–ã˜ãªã•ã„ã€‚",
        f"ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ãŒé€²ã‚€ä¸­ã§{selected_trend}ãŒ{selected_context}ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦ã€ãƒ¡ãƒªãƒƒãƒˆã¨ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’æ¯”è¼ƒæ¤œè¨ã—ã€ä»Šå¾Œã®æ–¹å‘æ€§ã‚’è¿°ã¹ãªã•ã„ã€‚"
    ]
    
    return random.choice(question_styles)

# å¤§å­¦æ¤œç´¢æ©Ÿèƒ½
def search_universities(query: str, universities: List[University]) -> List[University]:
    """å¤§å­¦æ¤œç´¢æ©Ÿèƒ½"""
    if not query:
        return universities
    
    query_lower = query.lower()
    filtered = []
    
    for uni in universities:
        # å¤§å­¦åã§ã®æ¤œç´¢
        if query_lower in uni.name.lower():
            filtered.append(uni)
            continue
        
        # å­¦éƒ¨åã§ã®æ¤œç´¢
        for faculty in uni.faculties:
            if query_lower in faculty.name.lower():
                filtered.append(uni)
                break
        
        # å­¦ç§‘åã§ã®æ¤œç´¢
        for faculty in uni.faculties:
            for dept in faculty.departments:
                if query_lower in dept.name.lower():
                    filtered.append(uni)
                    break
            if uni in filtered:
                break
    
    return filtered

# ãƒ¡ã‚¤ãƒ³é–¢æ•°
def main():
    st.title("ğŸ¤– AIæ­è¼‰ ç·åˆé¸æŠœå‹å…¥è©¦ å°è«–æ–‡å¯¾ç­–ã‚¢ãƒ—ãƒª")
    st.markdown("### æœ€æ–°AIæŠ€è¡“ã«ã‚ˆã‚‹è©³ç´°è©•ä¾¡ãƒ»å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ»æ¨¡ç¯„è§£ç­”ç”Ÿæˆ")
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
    if 'page' not in st.session_state:
        st.session_state.page = 'selection'
    if 'search_history' not in st.session_state:
        st.session_state.search_history = []
    if 'selected_university' not in st.session_state:
        st.session_state.selected_university = None
    if 'selected_faculty' not in st.session_state:
        st.session_state.selected_faculty = None
    if 'selected_department' not in st.session_state:
        st.session_state.selected_department = None
    if 'current_question' not in st.session_state:
        st.session_state.current_question = None
    if 'essay_content' not in st.session_state:
        st.session_state.essay_content = ""
    if 'essay_score' not in st.session_state:
        st.session_state.essay_score = None
    if 'timer_started' not in st.session_state:
        st.session_state.timer_started = False
    if 'start_time' not in st.session_state:
        st.session_state.start_time = None
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼
    with st.sidebar:
        st.header("ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³")
        
        if st.button("ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹", key="home_btn"):
            reset_all_state()
            st.rerun()
        
        st.markdown("---")
        st.markdown("### ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹")
        
        if st.session_state.page == 'selection':
            st.info("ğŸ” å¤§å­¦ãƒ»å­¦éƒ¨é¸æŠä¸­")
        elif st.session_state.page == 'writing':
            st.info("âœï¸ AIå°è«–æ–‡ç·´ç¿’ä¸­")
        elif st.session_state.page == 'result':
            st.info("ğŸ“ˆ AIè©³ç´°è©•ä¾¡è¡¨ç¤ºä¸­")
        
        # æ¤œç´¢å±¥æ­´ã®è¡¨ç¤º
        if st.session_state.search_history:
            st.markdown("### ğŸ•’ æ¤œç´¢å±¥æ­´")
            for i, search_term in enumerate(reversed(st.session_state.search_history[-5:])):
                if st.button(f"ğŸ“š {search_term}", key=f"history_{i}"):
                    st.session_state.quick_search = search_term
                    st.rerun()
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    if st.session_state.page == 'selection':
        show_advanced_university_selection()
    elif st.session_state.page == 'writing':
        show_ai_essay_editor()
    elif st.session_state.page == 'result':
        show_detailed_results()

def reset_all_state():
    """å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ"""
    st.session_state.page = 'selection'
    st.session_state.selected_university = None
    st.session_state.selected_faculty = None
    st.session_state.selected_department = None
    st.session_state.current_question = None
    st.session_state.essay_content = ""
    st.session_state.essay_score = None
    st.session_state.timer_started = False
    st.session_state.start_time = None

def show_advanced_university_selection():
    """é«˜åº¦ãªå¤§å­¦é¸æŠç”»é¢"""
    st.header("ğŸ¯ AIå¤§å­¦æ¤œç´¢ãƒ»å­¦éƒ¨å­¦ç§‘é¸æŠã‚·ã‚¹ãƒ†ãƒ ")
    
    universities = get_universities()
    
    # å¤§å­¦æ¤œç´¢
    col1, col2 = st.columns([3, 1])
    
    with col1:
        # ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        default_search = ""
        if 'quick_search' in st.session_state:
            default_search = st.session_state.quick_search
            del st.session_state.quick_search
        
        search_query = st.text_input(
            "ğŸ” å¤§å­¦åãƒ»å­¦éƒ¨åãƒ»å­¦ç§‘åã§æ¤œç´¢", 
            value=default_search,
            placeholder="ä¾‹: æ—©ç¨²ç”°ã€æ”¿æ²»çµŒæ¸ˆã€æƒ…å ±ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³",
            key="search_input"
        )
    
    with col2:
        if st.button("ğŸ” æ¤œç´¢å®Ÿè¡Œ", key="search_btn"):
            if search_query and search_query not in st.session_state.search_history:
                st.session_state.search_history.append(search_query)
            st.rerun()
    
    # æ¤œç´¢çµæœã®è¡¨ç¤º
    if search_query:
        filtered_universities = search_universities(search_query, universities)
        
        if filtered_universities:
            st.success(f"ğŸ¯ æ¤œç´¢çµæœ: {len(filtered_universities)}ä»¶ã®å¤§å­¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ")
            
            # å¤§å­¦é¸æŠ
            uni_options = ["é¸æŠã—ã¦ãã ã•ã„"] + [uni.name for uni in filtered_universities]
            selected_uni_name = st.selectbox("ğŸ“š å¤§å­¦ã‚’é¸æŠ", uni_options, key="uni_select")
            
            if selected_uni_name != "é¸æŠã—ã¦ãã ã•ã„":
                selected_university = next(uni for uni in filtered_universities if uni.name == selected_uni_name)
                st.session_state.selected_university = selected_university
                
                # é¸æŠã•ã‚ŒãŸå¤§å­¦ã®è©³ç´°æƒ…å ±
                with st.expander(f"ğŸ“– {selected_university.name} ã®è©³ç´°æƒ…å ±", expanded=True):
                    st.markdown(f"**AOå…¥è©¦å¯¾å¿œå­¦éƒ¨æ•°:** {len([f for f in selected_university.faculties if f.has_ao])}å­¦éƒ¨")
                    
                    for faculty in selected_university.faculties:
                        if faculty.has_ao:
                            st.markdown(f"â€¢ **{faculty.name}**")
                            ao_depts = [d for d in faculty.departments if d.has_ao]
                            for dept in ao_depts:
                                st.markdown(f"  - {dept.name} (éå»å•é¡Œ: {len(dept.past_questions)}ä»¶)")
                
                # å­¦éƒ¨é¸æŠ
                ao_faculties = [fac for fac in selected_university.faculties if fac.has_ao]
                if ao_faculties:
                    st.markdown(f"### ğŸ›ï¸ {selected_university.name} - AOå…¥è©¦å¯¾å¿œå­¦éƒ¨")
                    
                    fac_options = ["é¸æŠã—ã¦ãã ã•ã„"] + [fac.name for fac in ao_faculties]
                    selected_fac_name = st.selectbox("å­¦éƒ¨ã‚’é¸æŠ", fac_options, key="fac_select")
                    
                    if selected_fac_name != "é¸æŠã—ã¦ãã ã•ã„":
                        selected_faculty = next(fac for fac in ao_faculties if fac.name == selected_fac_name)
                        st.session_state.selected_faculty = selected_faculty
                        
                        # å­¦ç§‘é¸æŠ
                        ao_departments = [dept for dept in selected_faculty.departments if dept.has_ao]
                        if ao_departments:
                            st.markdown(f"### ğŸ“ {selected_faculty.name} - AOå…¥è©¦å¯¾å¿œå­¦ç§‘")
                            
                            dept_options = ["é¸æŠã—ã¦ãã ã•ã„"] + [dept.name for dept in ao_departments]
                            selected_dept_name = st.selectbox("å­¦ç§‘ã‚’é¸æŠ", dept_options, key="dept_select")
                            
                            if selected_dept_name != "é¸æŠã—ã¦ãã ã•ã„":
                                selected_department = next(dept for dept in ao_departments if dept.name == selected_dept_name)
                                st.session_state.selected_department = selected_department
                                
                                # éå»5å¹´åˆ†ã®ãƒ†ãƒ¼ãƒè¡¨ç¤º
                                st.markdown(f"#### ğŸ“ {selected_department.name} - éå»5å¹´ã®å‡ºé¡Œãƒ†ãƒ¼ãƒ")
                                
                                if selected_department.past_questions:
                                    # å¹´åº¦é †ã«ä¸¦ã³æ›¿ãˆ
                                    sorted_questions = sorted(selected_department.past_questions, key=lambda x: x.year, reverse=True)
                                    
                                    for i, q in enumerate(sorted_questions):
                                        with st.expander(f"ğŸ“… {q.year}å¹´åº¦ ({q.time_limit}åˆ†)", expanded=(i < 2)):
                                            st.write(q.theme)
                                            if i < 2:  # æœ€æ–°2ä»¶ã¯è©³ç´°è¡¨ç¤º
                                                st.info(f"ğŸ’¡ ã“ã®å•é¡Œã®ç‰¹å¾´: ãƒ†ãƒ¼ãƒ '{q.theme[:15]}...' ã¯{q.year}å¹´ã®ç¤¾ä¼šæƒ…å‹¢ã‚’åæ˜ ã—ãŸå‡ºé¡Œã§ã™ã€‚")
                                
                                # AIå•é¡Œäºˆæƒ³ãƒ»ç·´ç¿’é–‹å§‹
                                st.markdown("---")
                                col1, col2 = st.columns(2)
                                
                                with col1:
                                    st.metric("ğŸ“Š åˆ†æãƒ‡ãƒ¼ã‚¿", f"éå»{len(selected_department.past_questions)}å¹´åˆ†")
                                
                                with col2:
                                    st.metric("â±ï¸ æƒ³å®šæ™‚é–“", f"{selected_department.past_questions[0].time_limit}åˆ†" if selected_department.past_questions else "90åˆ†")
                                
                                if st.button("ğŸ¤– AIäºˆæƒ³å•é¡Œã§ç·´ç¿’é–‹å§‹", type="primary", key="ai_start_btn"):
                                    with st.spinner("ğŸ§  AI ãŒéå»5å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦äºˆæƒ³å•é¡Œã‚’ç”Ÿæˆä¸­..."):
                                        time.sleep(2)  # AIå‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                                        ai_question = ai_generate_question(
                                            selected_department.past_questions,
                                            selected_university.name,
                                            selected_faculty.name,
                                            selected_department.name
                                        )
                                        st.session_state.current_question = ai_question
                                        st.session_state.page = 'writing'
                                        st.success("âœ¨ AIäºˆæƒ³å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼")
                                        time.sleep(1)
                                        st.rerun()
                else:
                    st.warning("ã“ã®å¤§å­¦ã«ã¯AOå…¥è©¦å¯¾å¿œå­¦éƒ¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        else:
            st.warning("ğŸš« è©²å½“ã™ã‚‹å¤§å­¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚")
    else:
        # æ¤œç´¢å‰ã®å…¨å¤§å­¦è¡¨ç¤º
        st.info("ğŸ’¡ ä¸Šè¨˜ã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã§å¤§å­¦åãƒ»å­¦éƒ¨åãƒ»å­¦ç§‘åã‚’æ¤œç´¢ã§ãã¾ã™")
        
        st.markdown("### ğŸ“š åˆ©ç”¨å¯èƒ½ãªå¤§å­¦ä¸€è¦§")
        for uni in universities:
            ao_faculty_count = len([f for f in uni.faculties if f.has_ao])
            with st.expander(f"{uni.name} (AOå¯¾å¿œ: {ao_faculty_count}å­¦éƒ¨)", expanded=False):
                for faculty in uni.faculties:
                    if faculty.has_ao:
                        ao_dept_count = len([d for d in faculty.departments if d.has_ao])
                        st.markdown(f"**{faculty.name}** ({ao_dept_count}å­¦ç§‘)")
                        for dept in faculty.departments:
                            if dept.has_ao:
                                st.markdown(f"  â€¢ {dept.name} - éå»å•é¡Œ{len(dept.past_questions)}ä»¶")

def show_ai_essay_editor():
    """AIå°è«–æ–‡ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç”»é¢"""
    if not st.session_state.current_question:
        st.error("å•é¡ŒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        return
    
    st.header("ğŸ¤– AIå°è«–æ–‡ç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ ")
    
    # AIç”Ÿæˆå•é¡Œã®è¡¨ç¤º
    st.markdown("### ğŸ§  AIäºˆæƒ³å•é¡Œ")
    
    # å•é¡Œç”Ÿæˆã®èª¬æ˜
    col1, col2 = st.columns([3, 1])
    
    with col1:
        st.info(st.session_state.current_question)
    
    with col2:
        if st.button("ğŸ”„ æ–°ã—ã„äºˆæƒ³å•é¡Œ", key="new_question_btn"):
            with st.spinner("ğŸ¤– æ–°ã—ã„äºˆæƒ³å•é¡Œã‚’ç”Ÿæˆä¸­..."):
                time.sleep(1)
                new_question = ai_generate_question(
                    st.session_state.selected_department.past_questions,
                    st.session_state.selected_university.name,
                    st.session_state.selected_faculty.name,
                    st.session_state.selected_department.name
                )
                st.session_state.current_question = new_question
                st.rerun()
    
    # å‡ºé¡Œæ¡ä»¶è¡¨ç¤º
    if st.session_state.selected_department and st.session_state.selected_department.past_questions:
        time_limit = st.session_state.selected_department.past_questions[0].time_limit
    else:
        time_limit = 90
        
    st.markdown(f"**ğŸ“‹ å‡ºé¡Œæ¡ä»¶:** åˆ¶é™æ™‚é–“ {time_limit}åˆ† | æ¨å¥¨æ–‡å­—æ•° 600-1000å­— | AIè©³ç´°è©•ä¾¡å¯¾è±¡")
    
    # AIåˆ†ææƒ…å ±
    with st.expander("ğŸ” ã“ã®äºˆæƒ³å•é¡Œã®AIåˆ†æ", expanded=False):
        st.markdown(f"""
        **ğŸ¯ åˆ†æçµæœ:**
        - éå»5å¹´ã®å‡ºé¡Œå‚¾å‘ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸæœ€æ–°äºˆæƒ³å•é¡Œ
        - ç¾åœ¨ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çµ„ã¿è¾¼ã¿æ¸ˆã¿
        - {st.session_state.selected_faculty.name}ã®å°‚é–€æ€§ã‚’è€ƒæ…®
        - å…¥è©¦æœ¬ç•ªãƒ¬ãƒ™ãƒ«ã®é›£æ˜“åº¦ã«èª¿æ•´
        """)
    
    # ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
    if not st.session_state.timer_started:
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("â° ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹", type="primary", key="timer_start_btn"):
                st.session_state.timer_started = True
                st.session_state.start_time = time.time()
                st.success("â° ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼")
                st.rerun()
        
        with col2:
            if st.button("â±ï¸ ã‚¿ã‚¤ãƒãƒ¼ãªã—ã§é–‹å§‹", key="no_timer_btn"):
                st.session_state.timer_started = True
                st.session_state.start_time = None
                st.info("â±ï¸ ã‚¿ã‚¤ãƒãƒ¼ãªã—ã§é–‹å§‹ã—ã¾ã—ãŸ")
                st.rerun()
        
        with col3:
            if st.button("ğŸ“– æ›¸ãæ–¹ã‚¬ã‚¤ãƒ‰", key="guide_btn"):
                show_writing_guide_modal()
        
        st.info("ğŸ’¡ æº–å‚™ãŒã§ããŸã‚‰ä¸Šã®ãƒœã‚¿ãƒ³ã§ç·´ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„")
        return
    
    # ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
    if st.session_state.start_time:
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button("ğŸ”„ æ™‚é–“æ›´æ–°", key="update_timer"):
                st.rerun()
        
        with col2:
            elapsed_time = time.time() - st.session_state.start_time
            minutes = int(elapsed_time // 60)
            seconds = int(elapsed_time % 60)
            st.metric("â±ï¸ çµŒéæ™‚é–“", f"{minutes}:{seconds:02d}")
        
        with col3:
            remaining_time = max(0, time_limit * 60 - elapsed_time)
            if remaining_time > 0:
                r_minutes = int(remaining_time // 60)
                r_seconds = int(remaining_time % 60)
                st.metric("â° æ®‹ã‚Šæ™‚é–“", f"{r_minutes}:{r_seconds:02d}")
                if remaining_time <= 300:  # 5åˆ†ä»¥ä¸‹
                    st.warning("âš ï¸ æ®‹ã‚Šæ™‚é–“ã‚ãšã‹ã§ã™ï¼")
            else:
                st.metric("â° æ®‹ã‚Šæ™‚é–“", "çµ‚äº†")
                st.error("â° åˆ¶é™æ™‚é–“çµ‚äº†ï¼æå‡ºã—ã¦ãã ã•ã„")
        
        with col4:
            progress = min(elapsed_time / (time_limit * 60), 1.0)
            st.metric("ğŸ“Š é€²è¡Œåº¦", f"{int(progress * 100)}%")
    else:
        st.info("â±ï¸ ã‚¿ã‚¤ãƒãƒ¼ãªã—ãƒ¢ãƒ¼ãƒ‰ã§ç·´ç¿’ä¸­")
    
    # AIå°è«–æ–‡ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼
    st.markdown("### âœï¸ AIå°è«–æ–‡ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼")
    
    essay_content = st.text_area(
        "ğŸ“ ã“ã“ã«å°è«–æ–‡ã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆAIãŒæ–‡ä½“ãƒ»æ§‹æˆãƒ»è«–ç†æ€§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æï¼‰",
        value=st.session_state.essay_content,
        height=400,
        placeholder="å°è«–æ–‡ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„...\n\nğŸ’¡ AIã‹ã‚‰ã®ãƒ’ãƒ³ãƒˆ:\n- åºè«–ã§æ˜ç¢ºãªå•é¡Œæèµ·ã‚’è¡Œã†\n- æœ¬è«–ã§å…·ä½“ä¾‹ã¨è«–æ‹ ã‚’ç¤ºã™\n- çµè«–ã§ä¸»å¼µã‚’ã¾ã¨ã‚ã‚‹",
        key="ai_essay_textarea"
    )
    
    # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸ“Š æ–‡å­—æ•°ãƒ»æ§‹æˆãƒã‚§ãƒƒã‚¯", key="check_count"):
            st.session_state.essay_content = essay_content
            st.rerun()
    
    with col2:
        current_content = essay_content if essay_content else st.session_state.essay_content
        word_count = len(current_content.replace(' ', '').replace('\n', ''))
        st.metric("ğŸ“ æ–‡å­—æ•°", word_count)
        
        # é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
        if word_count < 200:
            st.error("æ–‡å­—æ•°ä¸è¶³")
        elif word_count < 400:
            st.warning("ã‚„ã‚„ä¸è¶³")
        elif word_count < 800:
            st.success("é©åˆ‡")
        else:
            st.info("ååˆ†")
    
    with col3:
        paragraphs = len([p for p in current_content.split('\n') if p.strip()])
        st.metric("ğŸ“‘ æ®µè½æ•°", paragraphs)
        
        if paragraphs < 3:
            st.warning("æ§‹æˆè¦æ”¹å–„")
        else:
            st.success("æ§‹æˆè‰¯å¥½")
    
    # å†…å®¹ã‚’ä¿å­˜
    st.session_state.essay_content = essay_content
    
    # AIç°¡æ˜“åˆ†æï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
    if word_count >= 100:
        with st.expander("ğŸ¤– AIç°¡æ˜“åˆ†æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼", expanded=False):
            col1, col2, col3 = st.columns(3)
            
            with col1:
                has_examples = any(kw in current_content for kw in ['ä¾‹ãˆã°', 'å…·ä½“çš„ã«', 'ãŸã¨ãˆã°'])
                st.metric("å…·ä½“ä¾‹", "âœ“" if has_examples else "âœ—")
            
            with col2:
                has_logic = any(kw in current_content for kw in ['ãã®ãŸã‚', 'ãªãœãªã‚‰', 'ã“ã®ãŸã‚'])
                st.metric("è«–ç†æ¥ç¶š", "âœ“" if has_logic else "âœ—")
            
            with col3:
                has_counter = any(kw in current_content for kw in ['ä¸€æ–¹', 'ã—ã‹ã—', 'ãŸã ã—'])
                st.metric("å¤šè§’çš„è¦–ç‚¹", "âœ“" if has_counter else "âœ—")
    
    # æå‡ºãƒœã‚¿ãƒ³
    min_chars = 100
    can_submit = word_count >= min_chars
    
    if not can_submit:
        st.warning(f"âš ï¸ æå‡ºã«ã¯æœ€ä½{min_chars}æ–‡å­—å¿…è¦ã§ã™ï¼ˆç¾åœ¨: {word_count}æ–‡å­—ï¼‰")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        if st.button("ğŸ¤– AIè©³ç´°è©•ä¾¡ã§æå‡º", type="primary", disabled=not can_submit, key="ai_submit_btn"):
            st.session_state.essay_content = essay_content
            st.session_state.page = 'result'
            st.rerun()
    
    with col2:
        if st.button("ğŸ’¾ ä¸‹æ›¸ãä¿å­˜", key="save_draft"):
            st.session_state.essay_content = essay_content
            st.success("ğŸ’¾ ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸï¼")
    
    with col3:
        if st.button("ğŸ”„ ãƒªã‚»ãƒƒãƒˆ", key="reset_essay"):
            st.session_state.essay_content = ""
            st.rerun()
    
    with col4:
        if st.button("âŒ ä¸­æ–­", key="cancel_writing"):
            reset_all_state()
            st.rerun()

def show_writing_guide_modal():
    """æ›¸ãæ–¹ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«"""
    st.markdown("### ğŸ“– å°è«–æ–‡æ›¸ãæ–¹ã‚¬ã‚¤ãƒ‰")
    
    guide_tabs = st.tabs(["ğŸ“‹ æ§‹æˆ", "ğŸ’¡ å†…å®¹", "âœï¸ è¡¨ç¾", "ğŸ“ ä¾‹æ–‡"])
    
    with guide_tabs[0]:
        st.markdown("""
        #### å°è«–æ–‡ã®åŸºæœ¬æ§‹æˆ
        
        **1. åºè«–ï¼ˆå…¨ä½“ã®20%ï¼‰**
        - å•é¡Œæèµ·ï¼šã€Œã€œã«ã¤ã„ã¦ã€ã€Œã€œã«ãŠã„ã¦ã€
        - è«–ç‚¹ã®æ˜ç¢ºåŒ–
        - è‡ªåˆ†ã®ç«‹å ´ã®è¡¨æ˜
        
        **2. æœ¬è«–ï¼ˆå…¨ä½“ã®60%ï¼‰**
        - æ ¹æ‹ ã®æç¤ºï¼šã€Œãªãœãªã‚‰ã€ã€Œç†ç”±ã¯ã€
        - å…·ä½“ä¾‹ãƒ»ãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨ï¼šã€Œä¾‹ãˆã°ã€ã€Œå®Ÿéš›ã«ã€
        - åå¯¾æ„è¦‹ã¸ã®è¨€åŠï¼šã€Œä¸€æ–¹ã§ã€ã€Œã—ã‹ã—ã€
        
        **3. çµè«–ï¼ˆå…¨ä½“ã®20%ï¼‰**
        - è«–ç‚¹ã®æ•´ç†ï¼šã€Œä»¥ä¸Šã®ã‚ˆã†ã«ã€
        - ä¸»å¼µã®å†ç¢ºèªï¼šã€Œã“ã®ã‚ˆã†ã«ã€
        - ä»Šå¾Œã®å±•æœ›ï¼šã€Œä»Šå¾Œã¯ã€
        """)
    
    with guide_tabs[1]:
        st.markdown("""
        #### èª¬å¾—åŠ›ã®ã‚ã‚‹å†…å®¹ã®ä½œã‚Šæ–¹
        
        **å…·ä½“ä¾‹ã®æ´»ç”¨**
        - èº«è¿‘ã§ç†è§£ã—ã‚„ã™ã„äº‹ä¾‹
        - æ™‚äº‹çš„ãªè©±é¡Œã®å¼•ç”¨
        - è¤‡æ•°ã®è¦–ç‚¹ã‹ã‚‰ã®äº‹ä¾‹
        
        **ãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨**
        - ã€Œç´„70%ã®ã€ã€Œéå»10å¹´ã§ã€
        - ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã®å¼•ç”¨
        - æ¯”è¼ƒå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã®æç¤º
        
        **å°‚é–€æ€§ã®è¡¨ç¾**
        - å­¦éƒ¨ãƒ»å­¦ç§‘ã«é–¢é€£ã—ãŸå°‚é–€ç”¨èª
        - å­¦è¡“çš„ãªè¦–ç‚¹ã‹ã‚‰ã®åˆ†æ
        - æœ€æ–°ã®ç ”ç©¶å‹•å‘ã¸ã®è¨€åŠ
        """)
    
    with guide_tabs[2]:
        st.markdown("""
        #### é©åˆ‡ãªè¡¨ç¾æŠ€æ³•
        
        **æ–‡ä½“ã®çµ±ä¸€**
        - ã€Œã§ã‚ã‚‹èª¿ã€ã§çµ±ä¸€
        - æ•¬èªã¯ä½¿ã‚ãªã„
        - ä¸€äººç§°ã¯ã€Œç§ã€ã‚’ä½¿ç”¨
        
        **é¿ã‘ã‚‹ã¹ãè¡¨ç¾**
        - ã€Œã€œã¨æ€ã†ã€â†’ã€Œã€œã¨è€ƒãˆã‚‹ã€
        - ã€Œã€œã‹ã‚‚ã—ã‚Œãªã„ã€â†’ã€Œã€œã¨æ¨æ¸¬ã•ã‚Œã‚‹ã€
        - ã€Œçµ¶å¯¾ã«ã€ã€Œå¿…ãšã€â†’æ–­å®šã‚’é¿ã‘ã‚‹
        
        **åŠ¹æœçš„ãªè¡¨ç¾**
        - æ¯”å–©ã‚„ä¾‹ãˆè©±ã®æ´»ç”¨
        - å•ã„ã‹ã‘ã«ã‚ˆã‚‹é–¢å¿ƒå–šèµ·
        - å¯¾æ¯”ã«ã‚ˆã‚‹è«–ç‚¹ã®æ˜ç¢ºåŒ–
        """)
    
    with guide_tabs[3]:
        st.markdown("""
        #### é«˜è©•ä¾¡ã‚’å¾—ã‚‹æ–‡ç« ä¾‹
        
        **åºè«–ã®ä¾‹**
        ```
        ç¾ä»£ç¤¾ä¼šã«ãŠã‘ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã®é€²å±•ã¯ã€æˆ‘ã€…ã®ç”Ÿæ´»æ§˜å¼ã‚’
        æ ¹æœ¬çš„ã«å¤‰é©ã—ã¦ã„ã‚‹ã€‚ã“ã®å¤‰åŒ–ã«ã¤ã„ã¦ã€ãã®æ„ç¾©ã¨
        èª²é¡Œã‚’å¤šè§’çš„ã«æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
        ```
        
        **æœ¬è«–ã®ä¾‹**
        ```
        ã¾ãšã€ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã®åˆ©ç‚¹ã¨ã—ã¦ã€æƒ…å ±ã‚¢ã‚¯ã‚»ã‚¹ã®å¹³ç­‰åŒ–ãŒ
        æŒ™ã’ã‚‰ã‚Œã‚‹ã€‚ä¾‹ãˆã°ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ•™è‚²ã«ã‚ˆã‚Šåœ°ç†çš„åˆ¶ç´„ã‚’
        è¶…ãˆãŸå­¦ç¿’æ©Ÿä¼šãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã€‚ä¸€æ–¹ã§ã€ãƒ‡ã‚¸ã‚¿ãƒ«
        ãƒ‡ãƒã‚¤ãƒ‰ã¨ã„ã†èª²é¡Œã‚‚å­˜åœ¨ã™ã‚‹ã€‚
        ```
        
        **çµè«–ã®ä¾‹**
        ```
        ã“ã®ã‚ˆã†ã«ã€ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã¯å¤šå¤§ãªæ©æµã‚’ã‚‚ãŸã‚‰ã™ä¸€æ–¹ã§ã€
        ç¤¾ä¼šçš„èª²é¡Œã‚‚ç”Ÿã¿å‡ºã—ã¦ã„ã‚‹ã€‚é‡è¦ãªã“ã¨ã¯ã€æŠ€è¡“ã®ç™ºå±•ã¨
        äººé–“ä¸­å¿ƒã®ä¾¡å€¤è¦³ã‚’ä¸¡ç«‹ã•ã›ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚
        ```
        """)

def show_detailed_results():
    """AIè©³ç´°è©•ä¾¡çµæœç”»é¢"""
    st.header("ğŸ¤– AIè©³ç´°è©•ä¾¡çµæœ")
    
    # AIæ¡ç‚¹å®Ÿè¡Œ
    if st.session_state.essay_score is None:
        with st.spinner("ğŸ§  AI ãŒè©³ç´°åˆ†æä¸­... æ§‹æˆãƒ»å†…å®¹ãƒ»è«–ç†æ€§ãƒ»è¡¨ç¾ã‚’å¤šè§’çš„ã«è©•ä¾¡ã—ã¦ã„ã¾ã™"):
            progress_bar = st.progress(0)
            for i in range(100):
                time.sleep(0.02)
                progress_bar.progress(i + 1)
            
            st.session_state.essay_score = detailed_essay_scoring(
                st.session_state.essay_content, 
                st.session_state.current_question
            )
            progress_bar.empty()
    
    score = st.session_state.essay_score
    
    # ç·åˆè©•ä¾¡ãƒ˜ãƒƒãƒ€ãƒ¼
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        st.markdown("### ğŸ¯ AIç·åˆè©•ä¾¡")
        st.metric("ğŸ“Š ç·åˆç‚¹æ•°", f"{score['total']}/100ç‚¹", 
                 delta=f"{score['total'] - 60}/60ç‚¹ (å¹³å‡æ¯”)" if score['total'] >= 60 else None)
        
        # è©•ä¾¡ã‚°ãƒ¬ãƒ¼ãƒ‰
        if score['total'] >= 90:
            grade, color, comment = "S", "#9d4edd", "æœ€å„ªç§€"
        elif score['total'] >= 80:
            grade, color, comment = "A", "#22c55e", "å„ªç§€"
        elif score['total'] >= 70:
            grade, color, comment = "B", "#eab308", "è‰¯å¥½"
        elif score['total'] >= 60:
            grade, color, comment = "C", "#f97316", "æ™®é€š"
        elif score['total'] >= 50:
            grade, color, comment = "D", "#ef4444", "è¦æ”¹å–„"
        else:
            grade, color, comment = "F", "#dc2626", "ä¸åˆæ ¼"
        
        st.markdown(f"<h1 style='color: {color}'>è©•ä¾¡: {grade}ï¼ˆ{comment}ï¼‰</h1>", unsafe_allow_html=True)
    
    with col2:
        # åå·®å€¤é¢¨è¡¨ç¤º
        estimated_rank = min(80, max(20, score['total'] - 20))
        st.metric("ğŸ“ˆ æ¨å®šåå·®å€¤", f"{estimated_rank}")
        
        # åˆæ ¼å¯èƒ½æ€§
        if score['total'] >= 80:
            pass_rate = "95%ä»¥ä¸Š"
            pass_color = "green"
        elif score['total'] >= 70:
            pass_rate = "80-90%"
            pass_color = "green"
        elif score['total'] >= 60:
            pass_rate = "60-70%"
            pass_color = "orange"
        else:
            pass_rate = "40%ä»¥ä¸‹"
            pass_color = "red"
        
        st.metric("ğŸ¯ åˆæ ¼å¯èƒ½æ€§", pass_rate)
    
    with col3:
        # æ‰€è¦æ™‚é–“ãƒ»åŠ¹ç‡æ€§
        if st.session_state.start_time:
            elapsed = time.time() - st.session_state.start_time
            efficiency = score['total'] / max(elapsed / 60, 1)  # ç‚¹æ•°/åˆ†
            st.metric("âš¡ åŠ¹ç‡æ€§", f"{efficiency:.1f}ç‚¹/åˆ†")
        
        word_count = len(st.session_state.essay_content.replace(' ', '').replace('\n', ''))
        st.metric("ğŸ“ æ–‡å­—åŠ¹ç‡", f"{score['total'] / max(word_count, 1) * 100:.1f}ç‚¹/100å­—")
    
    # è©³ç´°ã‚¹ã‚³ã‚¢åˆ†æ
    st.markdown("### ğŸ“Š AIè©³ç´°ã‚¹ã‚³ã‚¢åˆ†æ")
    
    score_data = [
        ("ğŸ“‹ æ§‹æˆ", score['structure']['score'], 25, score['structure']['evaluation']),
        ("ğŸ’¡ å†…å®¹", score['content']['score'], 30, score['content']['evaluation']),
        ("ğŸ”— è«–ç†æ€§", score['logic']['score'], 25, score['logic']['evaluation']),
        ("âœï¸ è¡¨ç¾", score['expression']['score'], 20, score['expression']['evaluation'])
    ]
    
    for emoji_name, score_val, max_val, evaluation in score_data:
        col1, col2 = st.columns([1, 2])
        
        with col1:
            percentage = score_val / max_val if max_val > 0 else 0
            st.metric(emoji_name, f"{score_val}/{max_val}")
            st.progress(percentage)
            
            # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡
            if percentage >= 0.8:
                perf_color, perf_text = "#22c55e", "å„ªç§€"
            elif percentage >= 0.6:
                perf_color, perf_text = "#eab308", "è‰¯å¥½"
            elif percentage >= 0.4:
                perf_color, perf_text = "#f97316", "æ™®é€š"
            else:
                perf_color, perf_text = "#ef4444", "è¦æ”¹å–„"
            
            st.markdown(f"<span style='color: {perf_color}'>**{perf_text}**</span>", unsafe_allow_html=True)
        
        with col2:
            st.markdown(f"**AIè©•ä¾¡:** {evaluation}")
    
    # AIè©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    st.markdown("### ğŸ¤– AIè©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯")
    st.info(score['detailed_feedback'])
    
    # å…·ä½“çš„æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    if score['specific_advice']:
        st.markdown("### ğŸ’¡ AIå…·ä½“çš„æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹")
        for i, advice in enumerate(score['specific_advice'], 1):
            st.markdown(f"**{i}.** {advice}")
    
    # AIæ¨¡ç¯„è§£ç­”
    if score['model_answer']:
        with st.expander("ğŸ“– AIç”Ÿæˆæ¨¡ç¯„è§£ç­”", expanded=False):
            st.markdown("**ğŸ’¡ ã“ã®ãƒ†ãƒ¼ãƒã«å¯¾ã™ã‚‹AIæ¨¡ç¯„è§£ç­”ä¾‹:**")
            st.markdown(score['model_answer'])
            st.warning("âš ï¸ ã“ã‚Œã¯AIãŒç”Ÿæˆã—ãŸå‚è€ƒä¾‹ã§ã™ã€‚å®Ÿéš›ã®å…¥è©¦ã§ã¯è‡ªåˆ†ã®è¨€è‘‰ã§è¡¨ç¾ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚")
    
    # ä½œæˆæƒ…å ±ãƒ»çµ±è¨ˆ
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### ğŸ“Š ä½œæˆçµ±è¨ˆæƒ…å ±")
        word_count = len(st.session_state.essay_content.replace(' ', '').replace('\n', ''))
        st.write(f"**ğŸ“ ç·æ–‡å­—æ•°:** {word_count}æ–‡å­—")
        
        paragraphs = len([p for p in st.session_state.essay_content.split('\n') if p.strip()])
        st.write(f"**ğŸ“‘ æ®µè½æ•°:** {paragraphs}æ®µè½")
        
        sentences = len([s for s in re.split(r'[ã€‚ï¼ï¼Ÿ]', st.session_state.essay_content) if s.strip()])
        st.write(f"**ğŸ“„ æ–‡æ•°:** {sentences}æ–‡")
        
        if st.session_state.start_time:
            elapsed_time = time.time() - st.session_state.start_time
            minutes = int(elapsed_time // 60)
            seconds = int(elapsed_time % 60)
            st.write(f"**â±ï¸ æ‰€è¦æ™‚é–“:** {minutes}åˆ†{seconds}ç§’")
        else:
            st.write("**â±ï¸ æ‰€è¦æ™‚é–“:** ã‚¿ã‚¤ãƒãƒ¼æœªä½¿ç”¨")
    
    with col2:
        st.markdown("### ğŸ« å‡ºé¡Œæƒ…å ±")
        if st.session_state.selected_university:
            st.write(f"**ğŸ›ï¸ å¤§å­¦:** {st.session_state.selected_university.name}")
            st.write(f"**ğŸ“š å­¦éƒ¨:** {st.session_state.selected_faculty.name}")
            st.write(f"**ğŸ“ å­¦ç§‘:** {st.session_state.selected_department.name}")
        
        st.write("**ğŸ¤– å•é¡Œç”Ÿæˆ:** AIäºˆæƒ³å•é¡Œ")
        st.write("**ğŸ“Š è©•ä¾¡æ–¹å¼:** AIè©³ç´°åˆ†æ")
        st.write(f"**ğŸ“… å®Ÿæ–½æ—¥:** {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}")
    
    # ã‚ãªãŸã®è§£ç­”è¡¨ç¤º
    with st.expander("ğŸ“„ ã‚ãªãŸã®è§£ç­”ã‚’ç¢ºèª", expanded=False):
        st.markdown("#### ğŸ¯ å‡ºé¡Œãƒ†ãƒ¼ãƒ")
        st.write(st.session_state.current_question)
        st.markdown("#### âœï¸ ã‚ãªãŸã®è§£ç­”å†…å®¹")
        st.text_area("", value=st.session_state.essay_content, height=200, disabled=True)
    
    # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    st.markdown("### ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        if st.button("ğŸ”„ åŒã˜å•é¡Œã§å†æŒ‘æˆ¦", key="retry_same"):
            st.session_state.page = 'writing'
            st.session_state.essay_content = ""
            st.session_state.essay_score = None
            st.session_state.timer_started = False
            st.session_state.start_time = None
            st.rerun()
    
    with col2:
        if st.button("ğŸ¤– æ–°ã—ã„AIäºˆæƒ³å•é¡Œ", key="new_ai_question"):
            with st.spinner("ğŸ§  æ–°ã—ã„äºˆæƒ³å•é¡Œã‚’ç”Ÿæˆä¸­..."):
                time.sleep(1)
                new_question = ai_generate_question(
                    st.session_state.selected_department.past_questions,
                    st.session_state.selected_university.name,
                    st.session_state.selected_faculty.name,
                    st.session_state.selected_department.name
                )
                st.session_state.current_question = new_question
                st.session_state.page = 'writing'
                st.session_state.essay_content = ""
                st.session_state.essay_score = None
                st.session_state.timer_started = False
                st.session_state.start_time = None
                st.rerun()
    
    with col3:
        if st.button("ğŸ›ï¸ åˆ¥ã®å¤§å­¦ã§ç·´ç¿’", key="change_university"):
            reset_all_state()
            st.rerun()
    
    with col4:
        if st.button("ğŸ“Š çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", key="download_result"):
            # çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ç”Ÿæˆ
            result_text = f"""
AIå°è«–æ–‡è©•ä¾¡çµæœ

ã€åŸºæœ¬æƒ…å ±ã€‘
å¤§å­¦: {st.session_state.selected_university.name if st.session_state.selected_university else 'N/A'}
å­¦éƒ¨: {st.session_state.selected_faculty.name if st.session_state.selected_faculty else 'N/A'}  
å­¦ç§‘: {st.session_state.selected_department.name if st.session_state.selected_department else 'N/A'}
å®Ÿæ–½æ—¥: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}

ã€è©•ä¾¡çµæœã€‘
ç·åˆç‚¹æ•°: {score['total']}/100ç‚¹
- æ§‹æˆ: {score['structure']['score']}/25ç‚¹
- å†…å®¹: {score['content']['score']}/30ç‚¹  
- è«–ç†æ€§: {score['logic']['score']}/25ç‚¹
- è¡¨ç¾: {score['expression']['score']}/20ç‚¹

ã€AIè©•ä¾¡ã€‘
{score['detailed_feedback']}

ã€å‡ºé¡Œãƒ†ãƒ¼ãƒã€‘
{st.session_state.current_question}

ã€è§£ç­”å†…å®¹ã€‘
{st.session_state.essay_content}
            """
            
            st.download_button(
                label="ğŸ“„ è©•ä¾¡çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=result_text,
                file_name=f"essay_result_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                mime="text/plain"
            )

if __name__ == "__main__":
    main()